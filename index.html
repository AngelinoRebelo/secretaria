<!DOCTYPE html>
<html lang="pt-br" class="h-full bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADCA - Gestão de Membros</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Configuração Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1',
                            600: '#4f46e5', 700: '#4338ca', 900: '#312e81',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Utilitários */
        .nav-link { color: #6b7280; transition: all 0.2s; position: relative; }
        .nav-link:hover, .nav-link.active { color: #4f46e5; }
        .nav-link.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: #4f46e5; }
        
        .app-content-tab { display: none; animation: fadeIn 0.3s ease-out; }
        .app-content-tab.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .modal { display: none; position: fixed; inset: 0; z-index: 50; background: rgba(17,24,39,0.5); backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s; }
        .modal.open { display: flex; align-items: center; justify-content: center; opacity: 1; }
        
        /* Inputs Modernos */
        .form-input { width: 100%; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.625rem; transition: all 0.2s; }
        .form-input:focus { background: white; border-color: #6366f1; ring: 2px; outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        #toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { padding: 1rem; border-radius: 0.5rem; background: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid; display: flex; align-items: center; gap: 0.75rem; animation: slideIn 0.3s; min-width: 300px; }
        .toast-success { border-color: #10b981; } .toast-error { border-color: #ef4444; } .toast-warning { border-color: #f59e0b; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        body.logged-out #app-content { display: none; }
        body.logged-out #auth-screen { display: flex; }
        
        /* Scrollbar fina para modal */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col">

    <!-- TELA DE LOGIN -->
    <div id="auth-screen" class="flex-1 flex flex-col items-center justify-center bg-gradient-to-br from-brand-900 via-brand-700 to-indigo-900 p-4">
        <div class="bg-white/10 backdrop-blur-md border border-white/20 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-flex p-4 bg-white rounded-xl shadow-lg mb-4">
                    <img src="https://i.postimg.cc/NF8psJ8b/adca.png" alt="Logo" class="h-12 w-auto">
                </div>
                <h2 class="text-2xl font-bold text-white">Área Restrita</h2>
                <p class="text-indigo-200 text-sm">Gestão ADCA - Capoeira Grande</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div class="relative">
                    <i class="ph ph-envelope absolute left-3 top-3.5 text-indigo-200 text-lg"></i>
                    <input type="email" id="login-email" placeholder="Email" required class="w-full bg-white/10 border border-indigo-300/30 rounded-lg pl-10 pr-4 py-3 text-white placeholder-indigo-300/50 focus:outline-none focus:bg-white/20 focus:border-white/50 transition-all">
                </div>
                <div class="relative">
                    <i class="ph ph-lock-key absolute left-3 top-3.5 text-indigo-200 text-lg"></i>
                    <input type="password" id="login-password" placeholder="Senha" required class="w-full bg-white/10 border border-indigo-300/30 rounded-lg pl-10 pr-4 py-3 text-white placeholder-indigo-300/50 focus:outline-none focus:bg-white/20 focus:border-white/50 transition-all">
                </div>
                <div id="login-error" class="text-red-300 text-sm text-center h-5 font-medium"></div>
                <button type="submit" id="login-button" class="w-full bg-white text-brand-700 font-bold py-3 rounded-lg hover:bg-indigo-50 transition-colors flex justify-center gap-2 items-center shadow-lg">
                    Entrar <i class="ph ph-arrow-right"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- APLICAÇÃO PRINCIPAL -->
    <div id="app-content" class="hidden flex-1 flex flex-col">
        <!-- Header -->
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-30 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-3">
                        <img src="https://i.postimg.cc/NF8psJ8b/adca.png" class="h-8 w-auto">
                        <div>
                            <h1 class="text-lg font-bold text-gray-900 leading-tight">Secretaria ADCA</h1>
                            <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Capoeira Grande</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="user-email-display" class="text-sm font-medium text-gray-600 hidden md:block"></span>
                        <button id="logout-button" class="text-gray-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition-colors" title="Sair">
                            <i class="ph ph-sign-out text-xl"></i>
                        </button>
                    </div>
                </div>
                <!-- Abas de Navegação -->
                <div class="flex space-x-1 overflow-x-auto -mb-px">
                    <button data-tab="dashboard" class="app-tab-button nav-link active px-4 py-3 text-sm font-medium whitespace-nowrap flex items-center gap-2">
                        <i class="ph ph-squares-four text-lg"></i> Dashboard
                    </button>
                    <button data-tab="cadastro" class="app-tab-button nav-link px-4 py-3 text-sm font-medium whitespace-nowrap flex items-center gap-2">
                        <i class="ph ph-user-plus text-lg"></i> Novo Membro
                    </button>
                    <button data-tab="visualizar" class="app-tab-button nav-link px-4 py-3 text-sm font-medium whitespace-nowrap flex items-center gap-2">
                        <i class="ph ph-users text-lg"></i> Membros
                    </button>
                    <button data-tab="aniversariantes" class="app-tab-button nav-link px-4 py-3 text-sm font-medium whitespace-nowrap flex items-center gap-2">
                        <i class="ph ph-cake text-lg"></i> Aniversários
                    </button>
                </div>
            </div>
        </nav>

        <!-- Conteúdo -->
        <main class="flex-1 bg-gray-50 py-8 overflow-y-auto">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                
                <!-- DASHBOARD -->
                <div id="dashboard" class="app-content-tab active">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-shadow relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-1 h-full bg-brand-500"></div>
                            <p class="text-gray-500 text-sm font-medium uppercase">Total de Membros</p>
                            <div class="flex items-center justify-between mt-2">
                                <h3 id="dashboard-total-membros" class="text-4xl font-bold text-gray-900">--</h3>
                                <div class="p-3 bg-brand-50 text-brand-600 rounded-lg"><i class="ph ph-users-three text-2xl"></i></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CADASTRO -->
                <div id="cadastro" class="app-content-tab">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                        <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                            <h2 class="text-lg font-bold text-gray-900">Ficha de Cadastro</h2>
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">Campos Obrigatórios *</span>
                        </div>
                        <form id="member-form" class="p-6 space-y-8">
                            
                            <!-- FOTO UPLOAD -->
                            <div class="flex items-center gap-6">
                                <div class="relative group">
                                    <div class="w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden">
                                        <img id="foto_preview_cadastro" class="w-full h-full object-cover hidden">
                                        <i id="foto_icon_placeholder" class="ph ph-camera text-3xl text-gray-400"></i>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Foto de Perfil</label>
                                    <input type="file" id="foto_upload" name="foto_upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100 transition-colors cursor-pointer">
                                    <p class="text-xs text-gray-400 mt-1">Salvo no Banco de Imagens. Max 5MB.</p>
                                </div>
                            </div>

                            <!-- DADOS PESSOAIS -->
                            <div>
                                <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="ph ph-user"></i> Dados Pessoais</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    <div class="lg:col-span-2"><input type="text" name="nome" required placeholder="Nome Completo *" class="form-input"></div>
                                    <div><input type="text" name="funcao" placeholder="Função/Ministério" class="form-input"></div>
                                    
                                    <div><label class="text-xs text-gray-500">Data de Nascimento</label><input type="date" name="data_nascimento" class="form-input"></div>
                                    <div><label class="text-xs text-gray-500">Email *</label><input type="email" name="email" required placeholder="exemplo@email.com" class="form-input"></div>
                                    <div><label class="text-xs text-gray-500">Telefone</label><input type="tel" name="telefone" placeholder="(00) 00000-0000" class="form-input"></div>
                                    
                                    <div><input type="text" name="cpf" placeholder="CPF" class="form-input"></div>
                                    <div><input type="text" name="rg" placeholder="RG" class="form-input"></div>
                                    <div><input type="text" name="naturalidade" placeholder="Naturalidade" class="form-input"></div>
                                    
                                    <div class="lg:col-span-3"><input type="text" name="endereco" placeholder="Endereço Completo" class="form-input"></div>
                                    
                                    <div><input type="text" name="nome_pai" placeholder="Nome do Pai" class="form-input"></div>
                                    <div class="lg:col-span-2"><input type="text" name="nome_mae" placeholder="Nome da Mãe" class="form-input"></div>
                                    
                                    <div>
                                        <select id="estado_civil" name="estado_civil" class="form-input bg-white">
                                            <option value="">Estado Civil...</option>
                                            <option value="Solteiro(a)">Solteiro(a)</option>
                                            <option value="Casado(a)">Casado(a)</option>
                                            <option value="Divorciado(a)">Divorciado(a)</option>
                                            <option value="Viúvo(a)">Viúvo(a)</option>
                                        </select>
                                    </div>
                                    <div id="conjuge-field" class="hidden lg:col-span-2"><input type="text" name="conjuge" placeholder="Nome do Cônjuge" class="form-input"></div>
                                    
                                    <div><input type="text" name="profissao" placeholder="Profissão" class="form-input"></div>
                                    <div class="lg:col-span-2">
                                        <select name="escolaridade" class="form-input bg-white">
                                            <option value="">Escolaridade...</option>
                                            <option value="Ensino Fundamental">Ensino Fundamental</option>
                                            <option value="Ensino Médio">Ensino Médio</option>
                                            <option value="Ensino Superior">Ensino Superior</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- DADOS ECLESIÁSTICOS -->
                            <div>
                                <h3 class="text-sm font-bold text-brand-600 uppercase tracking-wider mb-4 flex items-center gap-2"><i class="ph ph-church"></i> Dados Eclesiásticos</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div><label class="text-xs text-gray-500">Data de Batismo</label><input type="date" name="data_batismo" class="form-input"></div>
                                    <div><label class="text-xs text-gray-500">Chegada na Igreja</label><input type="date" name="data_chegada" class="form-input"></div>
                                    <div class="lg:col-span-2"><input type="text" name="igreja_anterior" placeholder="Igreja Anterior" class="form-input mt-5"></div>
                                    <div class="lg:col-span-4"><input type="text" name="cargo_anterior" placeholder="Cargo Anterior" class="form-input"></div>
                                </div>
                            </div>

                            <div class="pt-4 border-t border-gray-100 flex justify-end">
                                <button type="submit" id="submit-button" class="bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg shadow-brand-500/30 transition-transform active:scale-95 flex items-center gap-2">
                                    <span>Salvar Cadastro</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- LISTA DE MEMBROS -->
                <div id="visualizar" class="app-content-tab">
                    <div class="flex flex-col md:flex-row gap-4 mb-6 justify-between items-center">
                        <form id="search-form" class="relative w-full md:w-96">
                            <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
                            <input type="text" id="search-input" placeholder="Pesquisar por nome..." class="w-full pl-10 pr-4 py-2 bg-white border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand-500">
                        </form>
                        <button id="report-button" class="bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-colors shadow-sm">
                            <i class="ph ph-printer"></i> Imprimir Relatório
                        </button>
                    </div>
                    
                    <div id="list-loading" class="py-12 flex justify-center"><div class="spinner border-brand-200 border-t-brand-600"></div></div>
                    
                    <div id="member-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        <!-- Cards via JS -->
                    </div>
                </div>

                <!-- ANIVERSARIANTES -->
                <div id="aniversariantes" class="app-content-tab">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <div class="bg-brand-600 p-4 text-white flex items-center gap-2">
                                <i class="ph ph-cake text-2xl"></i>
                                <h3 id="aniversariantes-mes-atual-titulo" class="font-bold text-lg">Mês Atual</h3>
                            </div>
                            <div id="aniversariantes-mes-atual-lista" class="p-4 space-y-2">
                                <!-- Lista JS -->
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 h-fit">
                            <h3 class="font-bold text-gray-900 mb-4 border-b border-gray-100 pb-2">Próximos Meses</h3>
                            <div id="aniversariantes-proximos-lista" class="space-y-4 text-sm"></div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- TOAST -->
    <div id="toast-container"></div>

    <!-- MODAL DETALHES (CORRIGIDO) -->
    <div id="details-modal" class="modal">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden m-4 max-h-[90vh] flex flex-col">
            <!-- Cabeçalho Azul Fixo -->
            <div class="relative h-28 bg-brand-600 shrink-0 z-0">
                <button class="modal-close-btn absolute top-4 right-4 text-white/80 hover:text-white p-1 rounded-full hover:bg-white/20 transition-colors z-20"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <!-- Área da Foto (Fixa, não rola) -->
            <div class="px-8 relative shrink-0 z-10">
                <div class="-mt-12 flex justify-between items-end mb-6">
                    <img id="modal-detalhes-foto" src="" class="w-24 h-24 rounded-full border-4 border-white shadow-md bg-gray-200 object-cover shrink-0">
                    
                    <div class="flex gap-2 mb-0 md:mb-2">
                        <button id="modal-edit-btn" class="px-4 py-2 bg-yellow-50 text-yellow-700 hover:bg-yellow-100 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"><i class="ph ph-pencil"></i> Editar</button>
                        <button id="modal-delete-btn" class="px-4 py-2 bg-red-50 text-red-700 hover:bg-red-100 rounded-lg text-sm font-medium transition-colors flex items-center gap-2"><i class="ph ph-trash"></i> Excluir</button>
                    </div>
                </div>
            </div>

            <!-- Conteúdo Rolável -->
            <div class="px-8 pb-8 overflow-y-auto flex-1 scrollbar-thin">
                <div>
                    <h2 id="modal-detalhes-nome" class="text-2xl font-bold text-gray-900 uppercase">--</h2>
                    <p id="modal-detalhes-funcao" class="text-brand-600 font-medium text-lg">--</p>
                </div>

                <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-8">
                    <!-- COLUNA 1: PESSOAL -->
                    <div class="space-y-4">
                        <h3 class="text-brand-600 font-bold text-sm uppercase border-b border-brand-100 pb-2">Informações Pessoais</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">Data de Nasc.</span><span id="modal-detalhes-data_nascimento" class="text-gray-900">--</span></div>
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">Telefone</span><span id="modal-detalhes-telefone" class="text-gray-900">--</span></div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">CPF</span><span id="modal-detalhes-cpf" class="text-gray-900">--</span></div>
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">RG</span><span id="modal-detalhes-rg" class="text-gray-900">--</span></div>
                        </div>

                        <div><span class="text-xs text-gray-500 uppercase font-semibold block">Email</span><span id="modal-detalhes-email" class="text-gray-900 break-words">--</span></div>
                        <div><span class="text-xs text-gray-500 uppercase font-semibold block">Endereço</span><span id="modal-detalhes-endereco" class="text-gray-900">--</span></div>
                        <div><span class="text-xs text-gray-500 uppercase font-semibold block">Naturalidade</span><span id="modal-detalhes-naturalidade" class="text-gray-900">--</span></div>

                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">Nome do Pai</span><span id="modal-detalhes-nome_pai" class="text-gray-900">--</span></div>
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">Nome da Mãe</span><span id="modal-detalhes-nome_mae" class="text-gray-900">--</span></div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 pt-2">
                             <div>
                                <span class="text-xs text-gray-500 uppercase font-semibold block">Estado Civil</span>
                                <span id="modal-detalhes-estado_civil" class="text-gray-900">--</span>
                            </div>
                            <div id="conjuge-detalhes-container" class="hidden">
                                <span class="text-xs text-gray-500 uppercase font-semibold block">Cônjuge</span>
                                <span id="modal-detalhes-conjuge" class="text-gray-900">--</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">Profissão</span><span id="modal-detalhes-profissao" class="text-gray-900">--</span></div>
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">Escolaridade</span><span id="modal-detalhes-escolaridade" class="text-gray-900">--</span></div>
                        </div>
                    </div>

                    <!-- COLUNA 2: ECLESIÁSTICO -->
                    <div class="space-y-4">
                        <h3 class="text-brand-600 font-bold text-sm uppercase border-b border-brand-100 pb-2">Informações Eclesiásticas</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">Data de Batismo</span><span id="modal-detalhes-data_batismo" class="text-gray-900">--</span></div>
                            <div><span class="text-xs text-gray-500 uppercase font-semibold block">Data de Chegada</span><span id="modal-detalhes-data_chegada" class="text-gray-900">--</span></div>
                        </div>

                        <div><span class="text-xs text-gray-500 uppercase font-semibold block">Igreja de Onde Veio</span><span id="modal-detalhes-igreja_anterior" class="text-gray-900">--</span></div>
                        <div><span class="text-xs text-gray-500 uppercase font-semibold block">Cargo que Ocupava</span><span id="modal-detalhes-cargo_anterior" class="text-gray-900">--</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDIÇÃO -->
    <div id="edit-modal" class="modal">
        <div class="modal-content bg-white w-full max-w-4xl rounded-2xl shadow-2xl m-4 p-6 max-h-[90vh] overflow-y-auto scrollbar-thin">
            <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-4">
                <h2 class="text-xl font-bold text-gray-900">Editar Membro</h2>
                <button class="modal-close-btn text-gray-400 hover:text-gray-600"><i class="ph ph-x text-2xl"></i></button>
            </div>
            <form id="edit-form" class="space-y-6">
                <div class="flex items-center gap-4">
                    <img id="foto_preview_edicao" class="w-16 h-16 rounded-full object-cover hidden">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700">Alterar Foto</label>
                        <input type="file" id="edit-foto_upload" name="foto_upload" accept="image/*" class="text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2"><input type="text" id="edit-nome" name="nome" placeholder="Nome" class="form-input"></div>
                    <div><input type="text" id="edit-funcao" name="funcao" placeholder="Função" class="form-input"></div>
                    
                    <div><input type="date" id="edit-data_nascimento" name="data_nascimento" class="form-input"></div>
                    <div><input type="tel" id="edit-telefone" name="telefone" placeholder="Telefone" class="form-input"></div>
                    <div><input type="email" id="edit-email" name="email" placeholder="Email" class="form-input"></div>
                    
                    <div><input type="text" id="edit-cpf" name="cpf" placeholder="CPF" class="form-input"></div>
                    <div><input type="text" id="edit-rg" name="rg" placeholder="RG" class="form-input"></div>
                    <div><input type="text" id="edit-naturalidade" name="naturalidade" placeholder="Naturalidade" class="form-input"></div>
                    
                    <div class="md:col-span-3"><input type="text" id="edit-endereco" name="endereco" placeholder="Endereço" class="form-input"></div>
                    
                    <div><input type="text" id="edit-nome_pai" name="nome_pai" placeholder="Pai" class="form-input"></div>
                    <div class="md:col-span-2"><input type="text" id="edit-nome_mae" name="nome_mae" placeholder="Mãe" class="form-input"></div>
                    
                    <div>
                        <select id="edit-estado_civil" name="estado_civil" class="form-input bg-white">
                            <option value="Solteiro(a)">Solteiro(a)</option>
                            <option value="Casado(a)">Casado(a)</option>
                            <option value="Divorciado(a)">Divorciado(a)</option>
                            <option value="Viúvo(a)">Viúvo(a)</option>
                        </select>
                    </div>
                    <div id="edit-conjuge-field" class="hidden md:col-span-2"><input type="text" id="edit-conjuge" name="conjuge" placeholder="Cônjuge" class="form-input"></div>
                    
                    <div><input type="text" id="edit-profissao" name="profissao" placeholder="Profissão" class="form-input"></div>
                    <div class="md:col-span-2">
                        <select id="edit-escolaridade" name="escolaridade" class="form-input bg-white">
                            <option value="">Escolaridade...</option>
                            <option value="Ensino Fundamental">Ensino Fundamental</option>
                            <option value="Ensino Médio">Ensino Médio</option>
                            <option value="Ensino Superior">Ensino Superior</option>
                        </select>
                    </div>

                    <div><input type="date" id="edit-data_batismo" name="data_batismo" class="form-input"></div>
                    <div><input type="date" id="edit-data_chegada" name="data_chegada" class="form-input"></div>
                    <div class="md:col-span-3 flex gap-4">
                        <input type="text" id="edit-igreja_anterior" name="igreja_anterior" placeholder="Igreja Ant." class="form-input w-1/2">
                        <input type="text" id="edit-cargo_anterior" name="cargo_anterior" placeholder="Cargo Ant." class="form-input w-1/2">
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 mt-4">
                    <label class="text-xs font-bold uppercase text-gray-500 mb-2 block">Confirmação</label>
                    <div class="flex gap-2">
                        <input type="password" id="edit-password" name="edit-password" placeholder="Sua senha atual" class="form-input">
                        <button type="submit" id="edit-submit-button" class="bg-brand-600 hover:bg-brand-700 text-white px-6 rounded-lg font-medium transition-colors">Salvar</button>
                    </div>
                    <div id="edit-error" class="text-red-500 text-xs mt-2"></div>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL EXCLUSÃO -->
    <div id="delete-modal" class="modal">
        <div class="modal-content bg-white p-8 rounded-2xl shadow-xl max-w-md w-full text-center">
            <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><i class="ph ph-warning text-3xl"></i></div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Excluir Membro?</h3>
            <p class="text-gray-500 text-sm mb-6">Esta ação removerá permanentemente o registro e a foto do banco de dados.</p>
            <form id="delete-form">
                <input type="password" id="delete-password" required placeholder="Confirme sua senha" class="form-input mb-2">
                <p id="delete-error" class="text-red-500 text-xs h-4 mb-4"></p>
                <div class="flex gap-3">
                    <button type="button" class="modal-close-btn flex-1 py-2 border border-gray-200 rounded-lg hover:bg-gray-50">Cancelar</button>
                    <button type="submit" id="delete-submit-button" class="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 shadow-lg shadow-red-500/30">Excluir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, collection, onSnapshot, query, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { createClient } from "https://esm.sh/@libsql/client/web";

        // =======================================================
        // ⚠️ CONFIGURAÇÃO DE SEGURANÇA - PREENCHA AQUI ⚠️
        // =======================================================
        // Para segurança, não deixe as chaves hardcoded se compartilhar o código.
        // Substitua os valores abaixo pelas suas credenciais reais do Turso.
        
        const TURSO_DB_URL = "https://secretariaadca-machaddoo.aws-us-west-2.turso.io"; 
        const TURSO_AUTH_TOKEN = "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3NjM3NDQ3NjEsImlkIjoiZjA1YjU2MTgtYWY4MS00MmE2LTk5MjgtZTc4ZGU4MTMyZGFmIiwicmlkIjoiMWQ1Yjk3NTMtNjk5OC00MmQ5LTg5MTktNzAwYjM5YmE2MGUyIn0._tzShbyqWAFJsZmXclqhTAgQmqaXas7bvHMJQ-cOPjaO2r8Zmr-WqP3YgyTqOSHXdxAa5yOemFQq4waL_0WdAw";

        // =======================================================

        const firebaseConfig = JSON.parse(`{
          "apiKey": "AIzaSyA59Apn8I_8uT7XBrMIS_zD1RdtHgJCzOA",
          "authDomain": "gestao-capoeira.firebaseapp.com",
          "projectId": "gestao-capoeira",
          "storageBucket": "gestao-capoeira.firebasestorage.app",
          "messagingSenderId": "90755919",
          "appId": "1:907559288919:web:a4afdb4ed23e9d11196312"
        }`);
        
        const MESES = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const PLACEHOLDER_IMG = "https://placehold.co/100x100/e2e8f0/718096?text=Foto";

        let app, auth, db, userId, membersRef, turso;
        let cache = {}, photos = {}, unsub = null, currentId = null;

        // --- TURSO ---
        async function initTurso() {
            // Verifica se o usuário configurou as chaves
            if(TURSO_DB_URL.includes("COLE_AQUI") || TURSO_AUTH_TOKEN.includes("COLE_AQUI")) {
                console.warn("⚠️ ATENÇÃO: Configure as chaves do Turso no início do script!");
                showMsg("Erro: Banco de Imagens não configurado no código.", "error");
                return;
            }
            
            try {
                turso = createClient({ url: TURSO_DB_URL, authToken: TURSO_AUTH_TOKEN });
                await turso.execute(`CREATE TABLE IF NOT EXISTS member_photos (member_id TEXT PRIMARY KEY, photo_data TEXT)`);
            } catch(e){ console.error("Turso Error", e); }
        }

        function compressImg(file) {
            return new Promise((resolve, reject) => {
                const r = new FileReader();
                r.readAsDataURL(file);
                r.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const MAX = 800;
                        let w=img.width, h=img.height;
                        if(w>h){ if(w>MAX){ h*=MAX/w; w=MAX; }} else { if(h>MAX){ w*=MAX/h; h=MAX; }}
                        cvs.width=w; cvs.height=h;
                        cvs.getContext('2d').drawImage(img,0,0,w,h);
                        resolve(cvs.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        async function savePhoto(id, data) { if(turso){ await turso.execute({sql:"INSERT OR REPLACE INTO member_photos VALUES (?,?)", args:[id,data]}); photos[id]=data; }}
        async function delPhoto(id) { if(turso){ await turso.execute({sql:"DELETE FROM member_photos WHERE member_id = ?", args:[id]}); delete photos[id]; }}
        async function loadPhotos() { if(turso){ const r = await turso.execute("SELECT * FROM member_photos"); photos={}; r.rows.forEach(row=>photos[row.member_id]=row.photo_data); renderList(); }}

        // --- UI UTILS ---
        const getEl = (id) => document.getElementById(id);
        const showMsg = (msg, type='success') => {
            const t = document.createElement('div');
            t.className = `toast ${type==='error'?'toast-error':type==='warning'?'toast-warning':'toast-success'}`;
            t.innerHTML = `<i class="ph ${type==='success'?'ph-check-circle':type==='error'?'ph-warning-circle':'ph-info'} text-xl"></i><span>${msg}</span>`;
            getEl('toast-container').appendChild(t);
            setTimeout(()=> { t.style.transform='translateX(100%)'; setTimeout(()=>t.remove(),300); }, 3000);
        };

        function renderList() {
            const list = getEl('member-list');
            getEl('list-loading').classList.add('hidden');
            list.innerHTML = '';
            
            const term = getEl('search-input').value.toLowerCase();
            const all = Object.values(cache).filter(m => (m.nome||'').toLowerCase().includes(term));
            all.sort((a,b) => (a.nome||'').localeCompare(b.nome||''));

            if(all.length === 0) return list.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">Nenhum membro encontrado.</div>';

            all.forEach(m => {
                const img = photos[m.id] || PLACEHOLDER_IMG;
                list.innerHTML += `
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition-all group relative">
                    <div class="flex items-center gap-4">
                        <img src="${img}" class="w-14 h-14 rounded-full object-cover border-2 border-white shadow-sm bg-gray-100">
                        <div class="overflow-hidden">
                            <h4 class="font-bold text-gray-900 truncate">${m.nome}</h4>
                            <p class="text-xs text-brand-600 uppercase font-bold tracking-wider truncate">${m.funcao || 'Membro'}</p>
                            <p class="text-xs text-gray-400 mt-1"><i class="ph ph-phone"></i> ${m.telefone||'-'}</p>
                        </div>
                    </div>
                    <button onclick="openDetails('${m.id}')" class="absolute inset-0 w-full h-full cursor-pointer z-10 opacity-0">Ver</button>
                </div>`;
            });
        }

        // --- HELPER VALORES ---
        function getValue(obj, key) {
            if (obj[key] !== undefined) return obj[key];
            const camel = key.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
            if (obj[camel] !== undefined) return obj[camel];
            return undefined;
        }

        // --- RELATÓRIO (RESTAURADO) ---
        window.generateMemberReport = () => {
            const allMembers = Object.values(cache);
            if (allMembers.length === 0) {
                showMsg("Nenhum membro para gerar relatório.", "warning");
                return;
            }

            allMembers.sort((a, b) => (a.nome || '').localeCompare(b.nome || ''));

            const reportWindow = window.open('', '_blank');
            if (!reportWindow) {
                showMsg("Desbloqueie pop-ups para ver o relatório.", "error");
                return;
            }

            let reportHTML = `
                <html>
                <head>
                    <title>Relatório de Membros - ADCA</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
                        th { background-color: #f2f2f2; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        .print-btn { display: block; margin: 0 auto 20px; padding: 10px 20px; background: #4f46e5; color: white; border: none; border-radius: 5px; cursor: pointer; }
                        @media print { .print-btn { display: none; } }
                    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">Imprimir Relatório</button>
                    <h1>Relatório de Membros</h1>
                    <p>Total de Membros: ${allMembers.length}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Função</th>
                                <th>Telefone</th>
                                <th>Email</th>
                                <th>Nascimento</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            allMembers.forEach(member => {
                const nome = getValue(member, 'nome') || 'N/A';
                const funcao = getValue(member, 'funcao') || 'N/A';
                const telefone = getValue(member, 'telefone') || 'N/A';
                const email = getValue(member, 'email') || 'N/A';
                const nasc = formatDate(getValue(member, 'data_nascimento'));

                reportHTML += `
                    <tr>
                        <td>${nome}</td>
                        <td>${funcao}</td>
                        <td>${telefone}</td>
                        <td>${email}</td>
                        <td>${nasc}</td>
                    </tr>
                `;
            });

            reportHTML += `
                        </tbody>
                    </table>
                    <p style="text-align: right; font-size: 0.8em; margin-top: 20px;">
                        Gerado em: ${new Date().toLocaleString('pt-BR')}
                    </p>
                </body>
                </html>
            `;

            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
        };

        window.openDetails = (id) => {
            currentId = id;
            const m = cache[id];
            if(!m) return;
            
            const fields = ['nome','funcao','telefone','email','data_nascimento','endereco','cpf','rg','estado_civil','conjuge','nome_pai','nome_mae','profissao','escolaridade','data_batismo','data_chegada','naturalidade','igreja_anterior','cargo_anterior'];
            fields.forEach(f => {
                const el = getEl(`modal-detalhes-${f}`);
                if(el) {
                    const val = getValue(m, f);
                    el.textContent = (f.includes('data') ? formatDate(val) : val) || '-';
                }
            });

            const imgEl = getEl('modal-detalhes-foto');
            imgEl.src = photos[id] || PLACEHOLDER_IMG;
            imgEl.classList.remove('hidden');
            
            const estCivil = getValue(m, 'estado_civil') || getValue(m, 'estadoCivil');
            if(estCivil === 'Casado(a)') getEl('conjuge-detalhes-container').classList.remove('hidden');
            else getEl('conjuge-detalhes-container').classList.add('hidden');

            getEl('details-modal').classList.add('open');
        };

        function formatDate(d) {
            if(!d) return '-';
            try {
                if (d.seconds) return new Date(d.seconds * 1000).toLocaleDateString('pt-BR');
                const date = new Date(d);
                if(typeof d === 'string' && d.length === 10) return new Date(d + 'T00:00:00').toLocaleDateString('pt-BR');
                if(!isNaN(date.getTime())) return date.toLocaleDateString('pt-BR');
                return d;
            } catch(e) { return d; }
        }

        // --- MAIN ---
        async function main() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            await initTurso();

            // Auth Listener
            onAuthStateChanged(auth, (user) => {
                if(user) {
                    userId = user.uid;
                    getEl('user-email-display').textContent = user.email;
                    document.body.classList.remove('logged-out');
                    getEl('auth-screen').classList.add('hidden');
                    getEl('app-content').classList.remove('hidden');
                    membersRef = collection(db, "dadosIgreja", "ADCA-CG", "membros");
                    startListener();
                    switchTab('dashboard');
                } else {
                    userId = null;
                    document.body.classList.add('logged-out');
                    getEl('auth-screen').classList.remove('hidden');
                    getEl('app-content').classList.add('hidden');
                    if(unsub) unsub();
                }
            });

            // Listeners
            function startListener() {
                loadPhotos();
                unsub = onSnapshot(query(membersRef), (snap) => {
                    cache = {};
                    let total = 0, aniv = [];
                    snap.forEach(d => {
                        const data = {id: d.id, ...d.data()};
                        cache[d.id] = data;
                        aniv.push(data);
                        total++;
                    });
                    getEl('dashboard-total-membros').textContent = total;
                    renderList();
                    updateAniversariantes(aniv);
                });
            }

            function updateAniversariantes(list) {
                const m = new Date().getMonth();
                const el = getEl('aniversariantes-mes-atual-lista');
                const prox = getEl('aniversariantes-proximos-lista');
                el.innerHTML = ''; prox.innerHTML = '';
                
                const grouped = Array(12).fill().map(()=>[]);
                list.forEach(x => {
                    const nasc = getValue(x, 'data_nascimento');
                    if(nasc) {
                        const d = new Date(nasc + 'T00:00:00'); 
                        if(!isNaN(d)) grouped[d.getMonth()].push({...x, dia: d.getDate()});
                    }
                });

                grouped.forEach(g => g.sort((a,b)=>a.dia-b.dia));

                // Mês Atual
                if(grouped[m].length) {
                    grouped[m].forEach(x => {
                        el.innerHTML += `<div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded"><span class="font-bold text-brand-600 w-8">${x.dia}</span><span class="flex-1 truncate">${x.nome}</span></div>`;
                    });
                } else el.innerHTML = '<p class="text-gray-400 text-sm italic">Nenhum.</p>';

                // Próximos
                for(let i=1; i<=11; i++) {
                    const idx = (m+i)%12;
                    if(grouped[idx].length) {
                        const names = grouped[idx].map(x=>`${x.dia} - ${x.nome}`).join(', ');
                        prox.innerHTML += `<div><span class="font-bold text-gray-700">${MESES[idx]}:</span> <span class="text-gray-500">${names}</span></div>`;
                    }
                }
            }

            // Forms & Buttons
            getEl('login-form').onsubmit = async(e) => {
                e.preventDefault();
                try { await signInWithEmailAndPassword(auth, getEl('login-email').value, getEl('login-password').value); }
                catch(e){ getEl('login-error').textContent = 'Erro de login.'; }
            };
            getEl('logout-button').onclick = () => signOut(auth);
            getEl('report-button').onclick = window.generateMemberReport;

            getEl('member-form').onsubmit = async(e) => {
                e.preventDefault();
                const btn = getEl('submit-button'); btn.disabled=true; btn.textContent = 'Salvando...';
                try {
                    const fd = new FormData(e.target);
                    const obj = { createdAt: new Date().toISOString() };
                    for(let [k,v] of fd.entries()) if(k!=='foto_upload') obj[k] = v;
                    
                    const ref = await addDoc(membersRef, obj);
                    const file = getEl('foto_upload').files[0];
                    if(file) await savePhoto(ref.id, await compressImg(file));
                    
                    showMsg('Membro cadastrado!');
                    e.target.reset();
                    getEl('foto_preview_cadastro').classList.add('hidden');
                    getEl('foto_icon_placeholder').classList.remove('hidden');
                    getEl('conjuge-field').classList.add('hidden');
                } catch(err) { console.error(err); showMsg('Erro.', 'error'); }
                btn.disabled=false; btn.textContent='Salvar Cadastro';
            };

            // Edit Logic
            getEl('modal-edit-btn').onclick = () => {
                const m = cache[currentId];
                if(!m) return;
                getEl('details-modal').classList.remove('open');
                
                const inputs = getEl('edit-form').querySelectorAll('input, select, textarea');
                inputs.forEach(i => {
                    if(i.type !== 'file' && i.type !== 'password') {
                        const val = getValue(m, i.name);
                        if(val) i.value = val;
                        else i.value = '';
                    }
                });
                
                const img = getEl('foto_preview_edicao');
                if(photos[currentId]) { img.src=photos[currentId]; img.classList.remove('hidden'); }
                else img.classList.add('hidden');

                const ec = getValue(m, 'estado_civil');
                if(ec ==='Casado(a)') getEl('edit-conjuge-field').classList.remove('hidden');
                else getEl('edit-conjuge-field').classList.add('hidden');
                
                getEl('edit-modal').classList.add('open');
            };

            getEl('edit-form').onsubmit = async(e) => {
                e.preventDefault();
                const pwd = getEl('edit-password').value;
                if(!pwd) return getEl('edit-error').textContent='Senha necessária.';
                
                try {
                    await reauthenticateWithCredential(auth.currentUser, EmailAuthProvider.credential(auth.currentUser.email, pwd));
                    const fd = new FormData(e.target);
                    const obj = { updatedAt: new Date().toISOString() };
                    for(let [k,v] of fd.entries()) if(k!=='foto_upload' && k!=='edit-password') obj[k] = v;
                    
                    await updateDoc(doc(db,"dadosIgreja","ADCA-CG","membros",currentId), obj);
                    const f = getEl('edit-foto_upload').files[0];
                    if(f) await savePhoto(currentId, await compressImg(f));
                    
                    showMsg('Atualizado!');
                    getEl('edit-modal').classList.remove('open');
                    getEl('edit-password').value='';
                } catch(e){ getEl('edit-error').textContent = 'Senha incorreta.'; }
            };

            // Delete Logic
            getEl('modal-delete-btn').onclick = () => {
                getEl('details-modal').classList.remove('open');
                getEl('delete-modal').classList.add('open');
            };
            getEl('delete-form').onsubmit = async(e) => {
                e.preventDefault();
                try {
                    await reauthenticateWithCredential(auth.currentUser, EmailAuthProvider.credential(auth.currentUser.email, getEl('delete-password').value));
                    await deleteDoc(doc(db,"dadosIgreja","ADCA-CG","membros",currentId));
                    await delPhoto(currentId);
                    showMsg('Excluído.');
                    getEl('delete-modal').classList.remove('open');
                    getEl('delete-password').value='';
                } catch(e){ getEl('delete-error').textContent='Senha incorreta.'; }
            };

            // Tabs & Modals
            document.querySelectorAll('.app-tab-button').forEach(b => b.onclick = () => switchTab(b.dataset.tab));
            function switchTab(id) {
                document.querySelectorAll('.app-content-tab').forEach(t=>t.classList.remove('active'));
                document.querySelectorAll('.app-tab-button').forEach(b=>b.classList.remove('active'));
                getEl(id).classList.add('active');
                document.querySelector(`[data-tab="${id}"]`).classList.add('active');
            }
            document.querySelectorAll('.modal-close-btn').forEach(b => b.onclick = (e) => e.target.closest('.modal').classList.remove('open'));
            
            // Utils
            getEl('search-input').oninput = renderList;
            getEl('estado_civil').onchange = (e) => e.target.value==='Casado(a)' ? getEl('conjuge-field').classList.remove('hidden') : getEl('conjuge-field').classList.add('hidden');
            getEl('edit-estado_civil').onchange = (e) => e.target.value==='Casado(a)' ? getEl('edit-conjuge-field').classList.remove('hidden') : getEl('edit-conjuge-field').classList.add('hidden');
            
            getEl('foto_upload').onchange = (e) => {
                if(e.target.files[0]) {
                    const url = URL.createObjectURL(e.target.files[0]);
                    getEl('foto_preview_cadastro').src=url;
                    getEl('foto_preview_cadastro').classList.remove('hidden');
                    getEl('foto_icon_placeholder').classList.add('hidden');
                }
            };
            getEl('edit-foto_upload').onchange = (e) => {
                if(e.target.files[0]) {
                    getEl('foto_preview_edicao').src=URL.createObjectURL(e.target.files[0]);
                    getEl('foto_preview_edicao').classList.remove('hidden');
                }
            };
        }
        document.addEventListener('DOMContentLoaded', main);
    </script>
</body>
</html>
