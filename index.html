<!DOCTYPE html>
<html lang="pt-br" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECRETÁRIA ADCA - CAPOEIRA GRANDE</title>
    <!-- Carrega o Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configura a fonte padrão (Inter) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- [NOVO] Script do Widget do Postimages -->
    <script src="https://postimages.org/js/postimage.js" async></script>

    <!-- [NOVO] Funções de Callback para o Postimages -->
    <script>
        // Esta função é chamada pelo widget do Postimages após o upload no formulário de CADASTRO
        function onUploadCadastro(response) {
            if (response && response.url) {
                const url = response.url; // Este é o link direto
                const inputHidden = document.getElementById('foto_url');
                const previewImg = document.getElementById('foto-preview');
                
                if (inputHidden) inputHidden.value = url;
                if (previewImg) {
                    previewImg.src = url;
                    previewImg.classList.remove('hidden');
                }
            } else {
                alert("Ocorreu um erro no upload. Tente novamente.");
            }
        }

        // Esta função é chamada pelo widget do Postimages após o upload no formulário de EDIÇÃO
        function onUploadEdicao(response) {
             if (response && response.url) {
                const url = response.url; // Este é o link direto
                const inputHidden = document.getElementById('edit-foto_url');
                const previewImg = document.getElementById('edit-foto-preview');
                
                if (inputHidden) inputHidden.value = url;
                if (previewImg) {
                    previewImg.src = url;
                    previewImg.classList.remove('hidden');
                }
            } else {
                alert("Ocorreu um erro no upload. Tente novamente.");
            }
        }
    </script>

    <style>
        /* Estilos para abas (Autenticação) - DO SEU CSS */
        .auth-tab-button.active {
            border-bottom-color: #3b82f6; /* Cor azul */
            color: #3b82f6;
            font-weight: 600;
        }
        .auth-tab-button {
            border-bottom-width: 3px;
            border-bottom-color: transparent;
            color: #6b7280; /* Cinza para inativo */
        }
        /* Ocultar conteúdo das abas de autenticação por padrão */
        .auth-content-tab {
            display: none;
        }
        /* Mostrar conteúdo da aba de autenticação ativa */
        .auth-content-tab.active {
            display: block;
        }

        /* Estilos para abas (Aplicação Principal) - DO SEU CSS */
        .app-tab-button.active {
            border-bottom-color: #ffffff; /* Cor branca */
            color: #ffffff;
            font-weight: 600;
        }
        .app-tab-button {
            border-bottom-width: 3px;
            border-bottom-color: transparent;
            color: #dbeafe; /* Azul claro para inativo */
            opacity: 0.8;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            padding-left: 0.25rem;
            padding-right: 0.25rem;
        }
        .app-tab-button:hover {
            opacity: 1;
        }
        /* Ocultar conteúdo das abas da aplicação por padrão */
        .app-content-tab {
            display: none;
        }
        /* Mostrar conteúdo da aba da aplicação ativa */
        .app-content-tab.active {
            display: block;
        }

        /* Estilo para modal (Janela Pop-up) - DO SEU CSS */
        .modal {
            display: none; /* Oculto por padrão */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5); /* Fundo mais escuro */
            padding-top: 50px;
            padding-bottom: 50px;
        }
        
        /* Ajuste para animação de fade-in/out */
        .modal {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal.open {
            display: flex; /* Usar flex para centralizar */
            opacity: 1;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto; /* Centralizado pelo flex */
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            transform: translateY(20px) scale(0.95);
            opacity: 0;
        }
        
        .modal.open .modal-content {
             transform: translateY(0) scale(1);
             opacity: 1;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Spinner de Carregamento - DO SEU CSS */
        .spinner {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
            border: 3px solid #d1d5db; /* border-gray-300 */
            border-top-color: #3b82f6; /* border-t-blue-500 */
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.8s linear infinite;
        }

        /* Spinner dentro de botões */
        button:disabled .spinner {
            border-top-color: #ffffff;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* Toast (Notificações) - DO SEU CSS */
        #toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 200;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideIn 0.3s ease-out forwards;
            opacity: 0;
        }

        .toast-success {
            background-color: #10b981; /* green-500 */
        }
        .toast-error {
            background-color: #ef4444; /* red-500 */
        }
        .toast-warning {
            background-color: #f59e0b; /* amber-500 */
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Estilos Adicionais para Layout */
        html, body {
            height: 100%;
        }
        
        /* Centraliza a tela de login */
        body.logged-out {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Oculta setas de input[type=number] */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Estilos para as fotos dos membros */
        .member-list-photo {
            width: 64px; /* w-16 */
            height: 64px; /* h-16 */
            border-radius: 9999px; /* rounded-full */
            object-fit: cover; /* object-cover */
            border: 2px solid #e5e7eb; /* border-2 border-gray-200 */
            flex-shrink: 0; /* Não encolhe */
        }
        .modal-details-photo {
            width: 96px; /* w-24 */
            height: 96px; /* h-24 */
            border-radius: 9999px; /* rounded-full */
            object-fit: cover; /* object-cover */
            border: 4px solid #e5e7eb; /* border-4 border-gray-200 */
            margin: 0 auto 1rem auto; /* mx-auto mb-4 */
        }

        /* [NOVO] Estilo para o preview da foto nos formulários */
        .form-photo-preview {
            width: 96px; /* w-24 */
            height: 96px; /* h-24 */
            border-radius: 9999px; /* rounded-full */
            object-fit: cover; /* object-cover */
            border: 2px solid #d1d5db; /* border-gray-300 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans min-h-full antialiased">

    <!-- Tela de Autenticação (Login) -->
    <div id="auth-screen" class="w-full max-w-md p-8">
        <!-- Card de Login Branco, parecido com a imagem -->
        <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
            
            <!-- INÍCIO DA SEÇÃO DO LOGO (LOGIN) -->
            <div class="flex flex-col items-center mb-8">
                <!-- 
                  ADICIONE A URL DA SUA LOGO AQUI 
                  Recomendo uma imagem com cerca de 80px de altura (h-20)
                -->
                <img src="https://i.postimg.cc/NF8psJ8b/adca.png" 
                     alt="Logo ADCA" 
                     class="h-20 w-auto mb-4 rounded-lg">
                <h2 class="text-3xl font-bold text-center text-blue-600">SECRETÁRIA ADCA</h2>
            </div>
            <!-- FIM DA SEÇÃO DO LOGO (LOGIN) -->
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="login-email" name="email" required 
                           class="w-full bg-white border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <input type="password" id="login-password" name="password" required 
                           class="w-full bg-white border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div id="login-error" class="text-red-600 text-sm h-4">
                    <!-- Mensagens de erro de login aqui -->
                </div>

                <button type="submit" id="login-button" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 ease-in-out flex items-center justify-center space-x-2 shadow-lg">
                    <span>Entrar</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Container Principal do App (Oculto por padrão) -->
    <div id="app-content" class="hidden w-full h-full">
        
        <!-- NOVO CABEÇALHO AZUL -->
        <header class="bg-blue-700 text-white shadow-md sticky top-0 z-30">
            <div class="container mx-auto max-w-6xl px-4 md:px-8">
                <div class="flex justify-between items-center py-4">
                    
                    <!-- INÍCIO DA SEÇÃO DO LOGO (CABEÇALHO) -->
                    <div class="flex items-center gap-3">
                        <!-- 
                          ADICIONE A URL DA SUA LOGO AQUI 
                          Recomendo uma imagem com cerca de 40px de altura (h-10)
                        -->
                        <img src="https://i.postimg.cc/NF8psJ8b/adca.png" 
                             alt="Logo" 
                             class="h-10 w-auto rounded-md">
                        <!-- Título completo para telas médias e maiores -->
                        <h1 class="text-2xl font-bold hidden sm:block">
                            SECRETARIA ADCA - CAPOEIRA GRANDE
                        </h1>
                        <!-- Título curto para telas pequenas -->
                        <h1 class="text-2xl font-bold sm:hidden">
                            ADCA-CG
                        </h1>
                    </div>
                    <!-- FIM DA SEÇÃO DO LOGO (CABEÇALHO) -->

                    <div class="flex items-center gap-4">
                        <span id="user-email-display" class="text-sm text-blue-100 hidden md:block"></span>
                        <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 text-sm">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- NOVA NAVEGAÇÃO DAS ABAS -->
            <nav class="bg-blue-700 border-t border-blue-600">
                <div class="container mx-auto max-w-6xl px-4 md:px-8">
                    <div class="flex flex-wrap space-x-6" aria-label="Tabs">
                        <button id="tab-btn-dashboard" type="button" data-tab="dashboard" class="app-tab-button active text-lg font-medium">
                            Dashboard
                        </button>
                        <button id="tab-btn-cadastro" type="button" data-tab="cadastro" class="app-tab-button text-lg font-medium">
                            Cadastrar Membro
                        </button>
                        <button id="tab-btn-visualizar" type="button" data-tab="visualizar" class="app-tab-button text-lg font-medium">
                            Visualizar Membros
                        </button>
                        <button id="tab-btn-aniversariantes" type="button" data-tab="aniversariantes" class="app-tab-button text-lg font-medium">
                            Aniversariantes
                        </button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- NOVO CONTAINER DE CONTEÚDO PRINCIPAL -->
        <main class="container mx-auto max-w-6xl p-4 md:p-8">
            <!-- Conteúdo das Abas -->
            <div>
                <!-- Aba 0: Dashboard -->
                <div id="dashboard" class="app-content-tab active">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Card Total de Membros -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 flex flex-col justify-between">
                            <h3 class="text-lg font-semibold text-blue-700">Total de Membros</h3>
                            <div id="dashboard-total-membros" class="text-5xl font-bold text-gray-900 mt-4">
                                <!-- Spinner de carregamento -->
                                <div class="spinner h-10 w-10 border-4 border-blue-500 rounded-full"></div>
                            </div>
                        </div>
                        <!-- Outros cards do dashboard podem ser adicionados aqui -->
                    </div>
                </div>

                <!-- Aba 1: Formulário de Cadastro -->
                <div id="cadastro" class="app-content-tab">
                    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200">
                        <form id="member-form" class="space-y-8">
                            
                            <!-- Seção de Informações Pessoais -->
                            <div>
                                <h3 class="text-xl font-semibold mb-5 text-blue-700 border-b border-gray-300 pb-2">Informações Pessoais</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5">
                                    <div class="md:col-span-2">
                                        <label for="nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                                        <input type="text" id="nome" name="nome" placeholder="Nome do membro" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="funcao" class="block text-sm font-medium text-gray-700 mb-1">Função/Ministério</label>
                                        <input type="text" id="funcao" name="funcao" placeholder="Ex: Diácono, Louvor" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>

                                    <!-- [NOVO] Upload de Foto -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Foto</label>
                                        <!-- O botão chama o widget. data-callback aponta para a função JS global -->
                                        <button type="button" class="postimage bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium" data-callback="onUploadCadastro">
                                            Carregar Foto...
                                        </button>
                                        <!-- Este input escondido vai guardar a URL da imagem -->
                                        <input type="hidden" id="foto_url" name="foto_url">
                                    </div>
                                    <div class="flex items-end">
                                        <!-- O preview da imagem aparece aqui -->
                                        <img id="foto-preview" src="" alt="Preview" class="form-photo-preview hidden">
                                    </div>
                                    <div>
                                        <label for="data_nascimento" class="block text-sm font-medium text-gray-700 mb-1">Data de Nasc.</label>
                                        <input type="date" id="data_nascimento" name="data_nascimento" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <!-- Fim da Alteração -->
                                    
                                    <div>
                                        <label for="telefone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                        <input type="tel" id="telefone" name="telefone" placeholder="(00) 90000-0000" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input type="email" id="email" name="email" placeholder="email@exemplo.com" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
                                        <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="rg" class="block text-sm font-medium text-gray-700 mb-1">RG</label>
                                        <input type="text" id="rg" name="rg" placeholder="00.000.000-0" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="naturalidade" class="block text-sm font-medium text-gray-700 mb-1">Naturalidade</label>
                                        <input type="text" id="naturalidade" name="naturalidade" placeholder="Ex: Rio de Janeiro - RJ" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="md:col-span-3">
                                        <label for="endereco" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label>
                                        <textarea id="endereco" name="endereco" rows="3" placeholder="Rua, Número, Bairro, CEP, Cidade, Estado" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="nome_pai" class="block text-sm font-medium text-gray-700 mb-1">Nome do Pai</label>
                                        <input type="text" id="nome_pai" name="nome_pai" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="nome_mae" class="block text-sm font-medium text-gray-700 mb-1">Nome da Mãe</label>
                                        <input type="text" id="nome_mae" name="nome_mae" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="estado_civil" class="block text-sm font-medium text-gray-700 mb-1">Estado Civil</label>
                                        <select id="estado_civil" name="estado_civil" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Selecione...</option>
                                            <option value="Solteiro(a)">Solteiro(a)</option>
                                            <option value="Casado(a)">Casado(a)</option>
                                            <option value="Divorciado(a)">Divorciado(a)</option>
                                            <option value="Viúvo(a)">Viúvo(a)</option>
                                        </select>
                                    </div>
                                    <div id="conjuge-field" class="hidden md:col-span-2">
                                        <label for="conjuge" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cônjuge</label>
                                        <input type="text" id="conjuge" name="conjuge" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="profissao" class="block text-sm font-medium text-gray-700 mb-1">Profissão</label>
                                        <input type="text" id="profissao" name="profissao" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="escolaridade" class="block text-sm font-medium text-gray-700 mb-1">Escolaridade</label>
                                        <select id="escolaridade" name="escolaridade" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="">Selecione...</option>
                                            <option value="Ensino Fundamental Incompleto">Ensino Fundamental Incompleto</option>
                                            <option value="Ensino Fundamental Completo">Ensino Fundamental Completo</option>
                                            <option value="Ensino Médio Incompleto">Ensino Médio Incompleto</option>
                                            <option value="Ensino Médio Completo">Ensino Médio Completo</option>
                                            <option value="Ensino Superior Incompleto">Ensino Superior Incompleto</option>
                                            <option value="Ensino Superior Completo">Ensino Superior Completo</option>
                                            <option value="Pós-graduação">Pós-graduação</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Seção de Informações Eclesiásticas -->
                            <div>
                                <h3 class="text-xl font-semibold mb-5 text-blue-700 border-b border-gray-300 pb-2">Informações Eclesiásticas</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5">
                                    <div>
                                        <label for="data_batismo" class="block text-sm font-medium text-gray-700 mb-1">Data de Batismo</label>
                                        <input type="date" id="data_batismo" name="data_batismo" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label for="data_chegada" class="block text-sm font-medium text-gray-700 mb-1">Data de Chegada na Igreja</label>
                                        <input type="date" id="data_chegada" name="data_chegada" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="md:col-span-3"></div> <!-- Espaçador -->
                                    <div>
                                        <label for="igreja_anterior" class="block text-sm font-medium text-gray-700 mb-1">Igreja de Onde Veio</label>
                                        <input type="text" id="igreja_anterior" name="igreja_anterior" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="cargo_anterior" class="block text-sm font-medium text-gray-700 mb-1">Cargo que Ocupava</label>
                                        <input type="text" id="cargo_anterior" name="cargo_anterior" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                            </div>

                            <button type="submit" id="submit-button" 
                                    class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 ease-in-out flex items-center justify-center space-x-2 shadow-lg">
                                <span>Cadastrar Membro</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Aba 2: Lista de Membros -->
                <div id="visualizar" class="app-content-tab">
                    <!-- Indicador de Carregamento -->
                    <div id="list-loading" class="text-center py-10">
                        <div class="spinner h-12 w-12 border-4 border-blue-500 rounded-full mx-auto"></div>
                        <p class="text-gray-600 mt-3">Carregando membros...</p>
                    </div>

                    <!-- [NOVO] Barra de Pesquisa -->
                    <form id="search-form" class="mb-6 flex flex-col sm:flex-row gap-3">
                        <input type="text" id="search-input" placeholder="Pesquisar membro por nome..."
                               class="flex-grow bg-white border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="flex gap-3">
                            <button type="submit" id="search-button"
                                    class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-5 rounded-lg transition duration-300 ease-in-out flex items-center justify-center space-x-2 shadow-lg">
                                <span>Pesquisar</span>
                            </button>
                            <button type="button" id="clear-search-button"
                                    class="w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2.5 px-5 rounded-lg transition duration-300 ease-in-out">
                                <span>Limpar</span>
                            </button>
                        </div>
                    </form>
                    <!-- [FIM NOVO] -->

                    <!-- Container da Lista -->
                    <div id="member-list" class="space-y-4">
                        <!-- Membros serão inseridos aqui -->
                    </div>
                </div>

                <!-- Aba 3: Aniversariantes -->
                <div id="aniversariantes" class="app-content-tab">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Coluna Mês Atual -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                            <h3 id="aniversariantes-mes-atual-titulo" class="text-2xl font-semibold text-blue-700 mb-5 border-b border-gray-300 pb-3">
                                Aniversariantes de...
                            </h3>
                            <div id="aniversariantes-mes-atual-lista" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                                <!-- Lista do mês atual será inserida aqui -->
                                <div class="spinner h-8 w-8 border-4 border-blue-500 rounded-full"></div>
                            </div>
                        </div>

                        <!-- Coluna Próximos Meses -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                            <h3 class="text-2xl font-semibold text-blue-700 mb-5 border-b border-gray-300 pb-3">
                                Próximos Meses
                            </h3>
                            <div id="aniversariantes-proximos-lista" class="space-y-5 max-h-[60vh] overflow-y-auto pr-2">
                                <!-- Lista dos próximos meses será inserida aqui -->
                                <div class="spinner h-8 w-8 border-4 border-blue-500 rounded-full"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Container de Toasts (Notificações) -->
    <div id="toast-container"></div>
    
    <!-- Modal de Detalhes -->
    <div id="details-modal" class="modal">
        <!-- Conteúdo do Modal -->
        <div class="modal-content relative bg-gray-100 text-gray-800 rounded-2xl shadow-xl w-full max-w-4xl p-6 md:p-8 mx-auto">
            <!-- Cabeçalho do Modal -->
            <div class="flex justify-between items-center pb-3 border-b border-gray-300">
                <h2 class="text-2xl font-bold text-blue-800">Detalhes do Membro</h2>
                <button class="close-button modal-close-btn">&times;</button>
            </div>

            <!-- Corpo do Modal -->
            <div class="space-y-6 mt-5">
                <!-- [NOVO] Foto do Membro no Modal -->
                <img id="modal-detalhes-foto" src="" alt="Foto do Membro" class="modal-details-photo hidden">

                <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <h3 class="text-lg font-semibold text-blue-700">Informações Pessoais</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-2 text-sm">
                        <div class="md:col-span-2"><strong>Nome:</strong> <span id="modal-detalhes-nome" class="font-medium text-gray-700"></span></div>
                        <div><strong>Função/Ministério:</strong> <span id="modal-detalhes-funcao" class="font-medium text-gray-700"></span></div>
                        <div><strong>Data de Nasc.:</strong> <span id="modal-detalhes-data_nascimento" class="font-medium text-gray-700"></span></div>
                        <div><strong>Telefone:</strong> <span id="modal-detalhes-telefone" class="font-medium text-gray-700"></span></div>
                        <div><strong>Email:</strong> <span id="modal-detalhes-email" class="font-medium text-gray-700"></span></div>
                        <div><strong>CPF:</strong> <span id="modal-detalhes-cpf" class="font-medium text-gray-700"></span></div>
                        <div><strong>RG:</strong> <span id="modal-detalhes-rg" class="font-medium text-gray-700"></span></div>
                        <div><strong>Naturalidade:</strong> <span id="modal-detalhes-naturalidade" class="font-medium text-gray-700"></span></div>
                        <div class="md:col-span-3"><strong>Endereço:</strong> <span id="modal-detalhes-endereco" class="block whitespace-pre-wrap font-medium text-gray-700"></span></div>
                        <div class="md:col-span-1"><strong>Nome do Pai:</strong> <span id="modal-detalhes-nome_pai" class="font-medium text-gray-700"></span></div>
                        <div class="md:col-span-2"><strong>Nome da Mãe:</strong> <span id="modal-detalhes-nome_mae" class="font-medium text-gray-700"></span></div>
                        <div><strong>Estado Civil:</strong> <span id="modal-detalhes-estado_civil" class="font-medium text-gray-700"></span></div>
                        <div id="conjuge-detalhes-container" class="hidden md:col-span-2"><strong>Cônjuge:</strong> <span id="modal-detalhes-conjuge" class="font-medium text-gray-700"></span></div>
                        <div><strong>Profissão:</strong> <span id="modal-detalhes-profissao" class="font-medium text-gray-700"></span></div>
                        <div class="md:col-span-2"><strong>Escolaridade:</strong> <span id="modal-detalhes-escolaridade" class="font-medium text-gray-700"></span></div>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-blue-700 pt-4 border-t border-gray-300">Informações Eclesiásticas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-2 text-sm">
                        <div><strong>Data de Batismo:</strong> <span id="modal-detalhes-data_batismo" class="font-medium text-gray-700"></span></div>
                        <div><strong>Data de Chegada:</strong> <span id="modal-detalhes-data_chegada" class="font-medium text-gray-700"></span></div>
                        <div class="md:col-span-3"></div>
                        <div><strong>Igreja de Onde Veio:</strong> <span id="modal-detalhes-igreja_anterior" class="font-medium text-gray-700"></span></div>
                        <div class="md:col-span-2"><strong>Cargo que Ocupava:</strong> <span id="modal-detalhes-cargo_anterior" class="font-medium text-gray-700"></span></div>
                    </div>
                </div>
            </div>
            
            <!-- Rodapé do Modal com Botões -->
            <div class="flex flex-col md:flex-row justify-end items-center gap-3 pt-6 mt-6 border-t border-gray-300">
                <button id="modal-edit-btn" class="w-full md:w-auto bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                    Editar
                </button>
                <button id="modal-delete-btn" class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300">
                    Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edição (Agora light mode) -->
    <div id="edit-modal" class="modal">
        <!-- Conteúdo do Modal -->
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content relative bg-white text-gray-800 rounded-2xl shadow-xl w-full max-w-4xl p-6 md:p-8 mx-auto">
                <!-- Cabeçalho do Modal -->
                <div class="flex justify-between items-center pb-3 border-b border-gray-300">
                    <h2 class="text-2xl font-bold text-blue-700">Editar Membro</h2>
                    <button class="close-button modal-close-btn">&times;</button>
                </div>

                <!-- Formulário de Edição -->
                <form id="edit-form" class="mt-5 space-y-8">
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Campos de Edição (iguais ao de cadastro, mas com 'edit-' no id) -->
                        <div>
                            <h3 class="text-xl font-semibold mb-5 text-blue-700 border-b border-gray-300 pb-2">Informações Pessoais</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5">
                                <div class="md:col-span-2">
                                    <label for="edit-nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                                    <input type="text" id="edit-nome" name="nome" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="edit-funcao" class="block text-sm font-medium text-gray-700 mb-1">Função/Ministério</label>
                                    <input type="text" id="edit-funcao" name="funcao" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>

                                <!-- [NOVO] Upload de Foto (Edição) -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Foto</label>
                                    <button type="button" class="postimage bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-lg text-sm font-medium" data-callback="onUploadEdicao">
                                        Alterar Foto...
                                    </button>
                                    <input type="hidden" id="edit-foto_url" name="foto_url">
                                </div>
                                <div class="flex items-end">
                                    <img id="edit-foto-preview" src="" alt="Preview" class="form-photo-preview hidden">
                                </div>
                                <div>
                                    <label for="edit-data_nascimento" class="block text-sm font-medium text-gray-700 mb-1">Data de Nasc.</label>
                                    <input type="date" id="edit-data_nascimento" name="data_nascimento" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <!-- Fim da Alteração -->
                                
                                <div>
                                    <label for="edit-telefone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                                    <input type="tel" id="edit-telefone" name="telefone" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="edit-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="edit-email" name="email" required class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="edit-cpf" class="block text-sm font-medium text-gray-700 mb-1">CPF</label>
                                    <input type="text" id="edit-cpf" name="cpf" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="edit-rg" class="block text-sm font-medium text-gray-700 mb-1">RG</label>
                                    <input type="text" id="edit-rg" name="rg" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="edit-naturalidade" class="block text-sm font-medium text-gray-700 mb-1">Naturalidade</label>
                                    <input type="text" id="edit-naturalidade" name="naturalidade" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="md:col-span-3">
                                    <label for="edit-endereco" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label>
                                    <textarea id="edit-endereco" name="endereco" rows="3" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                </div>
                                <div class="md:col-span-1">
                                    <label for="edit-nome_pai" class="block text-sm font-medium text-gray-700 mb-1">Nome do Pai</label>
                                    <input type="text" id="edit-nome_pai" name="nome_pai" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="edit-nome_mae" class="block text-sm font-medium text-gray-700 mb-1">Nome da Mãe</label>
                                    <input type="text" id="edit-nome_mae" name="nome_mae" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="edit-estado_civil" class="block text-sm font-medium text-gray-700 mb-1">Estado Civil</label>
                                    <select id="edit-estado_civil" name="estado_civil" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Selecione...</option>
                                        <option value="Solteiro(a)">Solteiro(a)</option>
                                        <option value="Casado(a)">Casado(a)</option>
                                        <option value="Divorciado(a)">Divorciado(a)</option>
                                        <option value="Viúvo(a)">Viúvo(a)</option>
                                    </select>
                                </div>
                                <div id="edit-conjuge-field" class="hidden md:col-span-2">
                                    <label for="edit-conjuge" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cônjuge</label>
                                    <input type="text" id="edit-conjuge" name="conjuge" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="edit-profissao" class="block text-sm font-medium text-gray-700 mb-1">Profissão</label>
                                    <input type="text" id="edit-profissao" name="profissao" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="edit-escolaridade" class="block text-sm font-medium text-gray-700 mb-1">Escolaridade</label>
                                    <select id="edit-escolaridade" name="escolaridade" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Selecione...</option>
                                        <option value="Ensino Fundamental Incompleto">Ensino Fundamental Incompleto</option>
                                        <option value="Ensino Fundamental Completo">Ensino Fundamental Completo</option>
                                        <option value="Ensino Médio Incompleto">Ensino Médio Incompleto</option>
                                        <option value="Ensino Médio Completo">Ensino Médio Completo</option>
                                        <option value="Ensino Superior Incompleto">Ensino Superior Incompleto</option>
                                        <option value="Ensino Superior Completo">Ensino Superior Completo</option>
                                        <option value="Pós-graduação">Pós-graduação</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-5 text-blue-700 border-b border-gray-300 pb-2">Informações Eclesiásticas</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5">
                                <div>
                                    <label for="edit-data_batismo" class="block text-sm font-medium text-gray-700 mb-1">Data de Batismo</label>
                                    <input type="date" id="edit-data_batismo" name="data_batismo" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="edit-data_chegada" class="block text-sm font-medium text-gray-700 mb-1">Data de Chegada na Igreja</label>
                                    <input type="date" id="edit-data_chegada" name="data_chegada" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="md:col-span-3"></div> <!-- Espaçador -->
                                <div>
                                    <label for="edit-igreja_anterior" class="block text-sm font-medium text-gray-700 mb-1">Igreja de Onde Veio</label>
                                    <input type="text" id="edit-igreja_anterior" name="igreja_anterior" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="md:col-span-2">
                                    <label for="edit-cargo_anterior" class="block text-sm font-medium text-gray-700 mb-1">Cargo que Ocupava</label>
                                    <input type="text" id="edit-cargo_anterior" name="cargo_anterior" class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seção de Senha e Salvar -->
                    <div class="pt-6 mt-6 border-t border-gray-300 space-y-4">
                        <div>
                            <label for="edit-password" class="block text-sm font-medium text-gray-700 mb-1">Sua Senha (Obrigatória)</label>
                            <input type="password" id="edit-password" name="edit-password" required placeholder="Digite sua senha para confirmar"
                                   class="w-full md:w-1/2 bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div id="edit-error" class="text-red-600 text-sm h-4">
                            <!-- Mensagens de erro de edição aqui -->
                        </div>
                        <div class="flex justify-end gap-3">
                            <button type="button" class="modal-close-btn w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                                Cancelar
                            </button>
                            <button type="submit" id="edit-submit-button" 
                                    class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out flex items-center justify-center space-x-2 shadow-lg">
                                <span>Salvar Alterações</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal de Exclusão (Agora light mode) -->
    <div id="delete-modal" class="modal">
        <!-- Fundo escuro (Backdrop) -->
        <!-- <div class="modal-backdrop fixed inset-0 bg-black bg-opacity-75"></div> -->
        
        <!-- Conteúdo do Modal -->
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="modal-content relative bg-white text-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-6 md:p-8 mx-auto">
                <form id="delete-form">
                    <!-- Cabeçalho do Modal -->
                    <div class="flex justify-between items-center pb-3">
                        <h2 class="text-2xl font-bold text-red-600">Confirmar Exclusão</h2>
                        <button type="button" class="close-button modal-close-btn">&times;</button>
                    </div>

                    <!-- Corpo do Modal -->
                    <div class="mt-4 space-y-4">
                        <p class="text-gray-700">Você tem certeza que deseja excluir este membro? Esta ação não pode ser desfeita.</p>
                        <p class="text-yellow-600 text-sm">Aviso: Isso excluirá permanentemente o registro do membro. Os registros financeiros (dízimos, etc.) associados a ele NÃO serão excluídos.</p>
                        
                        <div>
                            <label for="delete-password" class="block text-sm font-medium text-gray-700 mb-1">Sua Senha (Obrigatória)</label>
                            <input type="password" id="delete-password" name="delete-password" required placeholder="Digite sua senha para confirmar"
                                   class="w-full bg-gray-50 border border-gray-300 rounded-lg px-4 py-2.5 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div id="delete-error" class="text-red-600 text-sm h-4">
                            <!-- Mensagens de erro de exclusão aqui -->
                        </div>
                    </div>

                    <!-- Rodapé do Modal com Botões -->
                    <div class="flex flex-col-reverse md:flex-row justify-end items-center gap-3 pt-6 mt-6 border-t border-gray-300">
                        <button type="button" class="modal-close-btn w-full md:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">
                            Cancelar
                        </button>
                        <button type="submit" id="delete-submit-button" 
                                class="w-full md:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out flex items-center justify-center space-x-2 shadow-lg">
                            <span>Excluir Permanentemente</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Importa as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            EmailAuthProvider, // Importa para reautenticação
            reauthenticateWithCredential // Importa para reautenticação
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            collection, 
            onSnapshot, 
            query, 
            setLogLevel,
            updateDoc, // Importa para edição
            deleteDoc,  // Importa para exclusão
            Timestamp // [CORREÇÃO] Importa o Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração do Firebase ---
        const userProvidedConfigString = `{
          "apiKey": "AIzaSyA59Apn8I_8uT7XBrMIS_zD1RdtHgJCzOA",
          "authDomain": "gestao-capoeira.firebaseapp.com",
          "projectId": "gestao-capoeira",
          "storageBucket": "gestao-capoeira.firebasestorage.app",
          "messagingSenderId": "90755919",
          "appId": "1:907559288919:web:a4afdb4ed23e9d11196312"
        }`;
        
        const firebaseConfig = JSON.parse(userProvidedConfigString);
        
        // --- Constantes ---
        const MESES_DO_ANO = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        // [NOVO] URL da foto placeholder
        const FOTO_PLACEHOLDER_URL = "https://placehold.co/100x100/e2e8f0/718096?text=Foto";


        // --- Variáveis Globais do App ---
        let app, auth, db, userId, membersCollectionRef;
        let membersCache = {}; // Cache para guardar dados dos membros
        let unsubscribeMembers = null; // Para parar de ouvir os dados ao fazer logout
        let currentMemberId = null; // Guarda o ID do membro selecionado (para edição/exclusão)

        // --- Elementos do DOM (Autenticação) ---
        const authScreen = document.getElementById('auth-screen');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const loginButtonText = loginButton.querySelector('span');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        const userEmailDisplay = document.getElementById('user-email-display');

        // --- Elementos do DOM (Abas) ---
        const tabButtons = document.querySelectorAll('.app-tab-button'); // Pega todos os botões de aba
        
        // --- Elementos do DOM (Dashboard) ---
        const dashboardTotalMembros = document.getElementById('dashboard-total-membros');

        // --- Elementos do DOM (Aniversariantes) ---
        const aniverMesAtualTitulo = document.getElementById('aniversariantes-mes-atual-titulo');
        const aniverMesAtualLista = document.getElementById('aniversariantes-mes-atual-lista');
        const aniverProximosLista = document.getElementById('aniversariantes-proximos-lista');

        // --- Elementos do DOM (Formulário de Cadastro) ---
        const memberForm = document.getElementById('member-form');
        const submitButton = document.getElementById('submit-button');
        const submitButtonText = submitButton.querySelector('span');
        const estadoCivilSelect = document.getElementById('estado_civil');
        const conjugeField = document.getElementById('conjuge-field');
        const fotoPreviewCadastro = document.getElementById('foto-preview'); // [NOVO]

        // --- Elementos do DOM (Lista) ---
        const memberList = document.getElementById('member-list');
        const listLoading = document.getElementById('list-loading');
        // [NOVO] Elementos de Pesquisa
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const clearSearchButton = document.getElementById('clear-search-button');

        // --- Elementos do DOM (Modal de Detalhes) ---
        const detailsModal = document.getElementById('details-modal');
        const modalEditBtn = document.getElementById('modal-edit-btn');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const modalSpans = {
            nome: document.getElementById('modal-detalhes-nome'),
            funcao: document.getElementById('modal-detalhes-funcao'),
            data_nascimento: document.getElementById('modal-detalhes-data_nascimento'),
            telefone: document.getElementById('modal-detalhes-telefone'),
            email: document.getElementById('modal-detalhes-email'),
            cpf: document.getElementById('modal-detalhes-cpf'),
            rg: document.getElementById('modal-detalhes-rg'),
            naturalidade: document.getElementById('modal-detalhes-naturalidade'),
            endereco: document.getElementById('modal-detalhes-endereco'),
            nome_pai: document.getElementById('modal-detalhes-nome_pai'),
            nome_mae: document.getElementById('modal-detalhes-nome_mae'),
            estado_civil: document.getElementById('modal-detalhes-estado_civil'),
            conjuge: document.getElementById('modal-detalhes-conjuge'),
            conjugeContainer: document.getElementById('conjuge-detalhes-container'),
            profissao: document.getElementById('modal-detalhes-profissao'),
            escolaridade: document.getElementById('modal-detalhes-escolaridade'),
            data_batismo: document.getElementById('modal-detalhes-data_batismo'),
            data_chegada: document.getElementById('modal-detalhes-data_chegada'),
            igreja_anterior: document.getElementById('modal-detalhes-igreja_anterior'),
            cargo_anterior: document.getElementById('modal-detalhes-cargo_anterior'),
            foto: document.getElementById('modal-detalhes-foto') // [NOVO] Span da foto
        };

        // --- Elementos do DOM (Modal de Edição) ---
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const editEstadoCivilSelect = document.getElementById('edit-estado_civil');
        const editConjugeField = document.getElementById('edit-conjuge-field');
        const editSubmitButton = document.getElementById('edit-submit-button');
        const editSubmitButtonText = editSubmitButton.querySelector('span');
        const editError = document.getElementById('edit-error');
        const fotoPreviewEdicao = document.getElementById('edit-foto-preview'); // [NOVO]

        // --- Elementos do DOM (Modal de Exclusão) ---
        const deleteModal = document.getElementById('delete-modal');
        const deleteForm = document.getElementById('delete-form');
        const deleteSubmitButton = document.getElementById('delete-submit-button');
        const deleteSubmitButtonText = deleteSubmitButton.querySelector('span');
        const deleteError = document.getElementById('delete-error');

        // --- Elementos do DOM (Geral) ---
        const toastContainer = document.getElementById('toast-container');
        const allCloseModalButtons = document.querySelectorAll('.modal-close-btn');

        // --- Funções Auxiliares ---

        // [NOVO] FUNÇÃO DE LOG (COPIADA DO GESTAO-IGJE.JS)
        /**
         * Registra uma ação no log do Firestore.
         * @param {string} acao - Ação realizada (ex: "Membro Criado", "Exclusão Dízimo").
         * @param {object} detalhes - Objeto com informações relevantes (ex: { membroId: '...' }).
         */
        async function registrarLog(acao, detalhes = {}) {
            // A função 'auth' é definida mais abaixo, no 'main'
            if (!auth || !auth.currentUser) {
                console.warn("Tentativa de log sem usuário autenticado.");
                return;
            }
            
            try {
                // USA A MESMA COLEÇÃO DE LOGS DO OUTRO SITE
                const logCollectionRef = collection(db, "dadosIgreja", "ADCA-CG", "logs");
                await addDoc(logCollectionRef, {
                    timestamp: Timestamp.now(), // [CORREÇÃO] Agora 'Timestamp' está importado
                    userId: auth.currentUser.uid,
                    userEmail: auth.currentUser.email,
                    acao: acao,
                    detalhes: detalhes // Armazena o objeto de detalhes
                });
            } catch (error) {
                console.error("Falha ao registrar log:", error);
                // Não notifica o usuário para não interromper o fluxo principal
            }
        }
        // [FIM DA FUNÇÃO DE LOG]


        /**
         * Exibe uma mensagem de feedback (Toast).
         */
        function showMessage(message, type = 'success') {
            const toast = document.createElement('div');
            let typeClass = 'toast-success';
            if (type === 'error') typeClass = 'toast-error';
            if (type === 'warning') typeClass = 'toast-warning';
            
            toast.className = `toast ${typeClass}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);

            // Remove o toast após 3 segundos
            setTimeout(() => {
                toast.style.animation = "slideOut 0.3s ease-out forwards";
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        /**
         * Converte string 'aaaa-mm-dd' para um Date UTC.
         * Retorna null se a data for inválida.
         */
        function getDateFromInput(dataInput) {
            try {
                if (!dataInput) return null;
                
                // Se for Timestamp do Firebase
                if (dataInput && typeof dataInput.toDate === 'function') {
                    return dataInput.toDate();
                }
                // Se já for Date
                if (dataInput instanceof Date) {
                    return dataInput;
                }
                // Se for string 'aaaa-mm-dd'
                if (typeof dataInput === 'string' && dataInput.includes('-')) {
                    const parts = dataInput.split('-');
                    if (parts.length === 3) {
                        // Ano, Mês (base 0), Dia
                        const date = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                        if (!isNaN(date.getTime())) return date;
                    }
                }
            } catch (e) {
                console.error("Data inválida:", dataInput, e);
                return null;
            }
            return null;
        }

        /**
         * Formata data (AAAA-MM-DD ou Date) para DD/MM/AAAA.
         */
        function formatarData(dataInput) {
            const dateObj = getDateFromInput(dataInput);
            if (!dateObj) return "N/A";
            
            try {
                return dateObj.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            } catch (e) {
                return "N/A";
            }
        }

        /**
         * Reautentica o usuário com a senha fornecida.
         * Lança um erro se a reautenticação falhar.
         */
        async function reauthenticateUser(password) {
            const user = auth.currentUser;
            if (!user) {
                throw new Error("Usuário não está logado.");
            }
            if (!user.email) {
                throw new Error("Usuário não tem email associado.");
            }

            try {
                const credential = EmailAuthProvider.credential(user.email, password);
                await reauthenticateWithCredential(user, credential);
                return true; // Sucesso
            } catch (error) {
                console.error("Erro ao reautenticar:", error.code);
                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    throw new Error("Senha incorreta.");
                } else {
                    throw new Error("Erro de autenticação.");
                }
            }
        }

        /**
         * [ALTERADO] Mapeia os dados de um membro para os campos do formulário de edição.
         */
        function populateEditForm(member) {
            document.getElementById('edit-nome').value = member.nome || '';
            document.getElementById('edit-funcao').value = member.funcao || '';
            document.getElementById('edit-foto_url').value = member.fotoUrl || ''; // [NOVO]
            document.getElementById('edit-data_nascimento').value = member.dataNascimento || ''; 
            document.getElementById('edit-telefone').value = member.telefone || '';
            document.getElementById('edit-email').value = member.email || '';
            document.getElementById('edit-cpf').value = member.cpf || '';
            document.getElementById('edit-rg').value = member.rg || '';
            document.getElementById('edit-naturalidade').value = member.naturalidade || '';
            document.getElementById('edit-endereco').value = member.endereco || '';
            document.getElementById('edit-nome_pai').value = member.nomePai || ''; 
            document.getElementById('edit-nome_mae').value = member.nomeMae || ''; 
            document.getElementById('edit-estado_civil').value = member.estadoCivil || ''; 
            document.getElementById('edit-conjuge').value = member.conjuge || '';
            document.getElementById('edit-profissao').value = member.profissao || '';
            document.getElementById('edit-escolaridade').value = member.escolaridade || '';
            document.getElementById('edit-data_batismo').value = member.dataBatismo || ''; 
            document.getElementById('edit-data_chegada').value = member.dataChegada || ''; 
            document.getElementById('edit-igreja_anterior').value = member.igrejaAnterior || ''; 
            document.getElementById('edit-cargo_anterior').value = member.cargoAnterior || ''; 

            // [NOVO] Lógica do preview de foto na edição
            if (member.fotoUrl) {
                fotoPreviewEdicao.src = member.fotoUrl;
                fotoPreviewEdicao.classList.remove('hidden');
            } else {
                fotoPreviewEdicao.src = '';
                fotoPreviewEdicao.classList.add('hidden');
            }

            // Lógica do campo Cônjuge
            if (member.estadoCivil === 'Casado(a)') { 
                editConjugeField.classList.remove('hidden');
            } else {
                editConjugeField.classList.add('hidden');
            }
            
            // Limpa campos de senha e erro
            document.getElementById('edit-password').value = '';
            editError.textContent = '';
        }

        /**
         * Abre um modal.
         */
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('open');
                document.body.style.overflow = 'hidden'; // Impede rolagem do fundo
            }
        }

        /**
         * Fecha o modal ativo.
         */
        function hideModal(modal) {
            if (modal) {
                modal.classList.remove('open');
                // O CSS do modal agora o esconde (display: none)
                document.body.style.overflow = '';
            }
        }

        /**
         * [ALTERADO] Exibe o modal com os detalhes do membro, incluindo a foto.
         */
        function showDetailsModal() {
            const member = membersCache[currentMemberId];
            if (!member) return;

            // [NOVO] Preenche a foto
            if (member.fotoUrl) {
                modalSpans.foto.src = member.fotoUrl;
                modalSpans.foto.classList.remove('hidden');
            } else {
                modalSpans.foto.src = ''; // Limpa se não houver foto
                modalSpans.foto.classList.add('hidden');
            }

            // Preenche os campos de texto
            modalSpans.nome.textContent = member.nome || 'N/A';
            modalSpans.funcao.textContent = member.funcao || 'N/A';
            modalSpans.data_nascimento.textContent = formatarData(member.dataNascimento);
            modalSpans.telefone.textContent = member.telefone || 'N/A';
            modalSpans.email.textContent = member.email || 'N/A';
            modalSpans.cpf.textContent = member.cpf || 'N/A';
            modalSpans.rg.textContent = member.rg || 'N/A';
            modalSpans.naturalidade.textContent = member.naturalidade || 'N/A';
            modalSpans.endereco.textContent = member.endereco || 'N/A';
            modalSpans.nome_pai.textContent = member.nomePai || 'N/A';
            modalSpans.nome_mae.textContent = member.nomeMae || 'N/A';
            modalSpans.estado_civil.textContent = member.estadoCivil || 'N/A';
            modalSpans.profissao.textContent = member.profissao || 'N/A';
            modalSpans.escolaridade.textContent = member.escolaridade || 'N/A';
            modalSpans.data_batismo.textContent = formatarData(member.dataBatismo);
            modalSpans.data_chegada.textContent = formatarData(member.dataChegada);
            modalSpans.igreja_anterior.textContent = member.igrejaAnterior || 'N/A';
            modalSpans.cargo_anterior.textContent = member.cargoAnterior || 'N/A';
            
            // Lógica para campo Cônjuge
            if (member.estadoCivil === 'Casado(a)' && member.conjuge) {
                modalSpans.conjuge.textContent = member.conjuge;
                modalSpans.conjugeContainer.classList.remove('hidden');
            } else {
                modalSpans.conjuge.textContent = '';
                modalSpans.conjugeContainer.classList.add('hidden');
            }

            // Exibe o modal
            showModal('details-modal');
        }

        /**
         * [ALTERADO] Renderiza a lista de membros no DOM com foto.
         */
        function renderMemberList(memberArray) {
            listLoading.classList.add('hidden');
            memberList.innerHTML = ''; // Limpa a lista atual

            if (memberArray.length === 0) {
                 // Mensagem mais amigável se for filtro
                const searchTerm = searchInput.value;
                if (searchTerm) {
                    memberList.innerHTML = `<p class="text-gray-600 text-center">Nenhum membro encontrado para "${searchTerm}".</p>`;
                } else {
                    memberList.innerHTML = '<p class="text-gray-600 text-center">Nenhum membro cadastrado ainda.</p>';
                }
                return;
            }

            memberArray.forEach((member) => {
                const memberEl = document.createElement('div');
                // [NOVO] Card de membro com foto
                memberEl.className = "bg-white p-4 rounded-lg shadow-md border border-gray-200 flex items-center gap-4";
                
                const nome = member.nome || 'Nome não informado';
                const funcao = member.funcao || 'Sem função';
                const telefone = member.telefone || 'Sem telefone';
                const fotoUrl = member.fotoUrl || FOTO_PLACEHOLDER_URL; // Usa o placeholder

                memberEl.innerHTML = `
                    <img src="${fotoUrl}" alt="Foto de ${nome}" class="member-list-photo">
                    <div class="flex-grow">
                        <h3 class="text-xl font-semibold text-blue-700">${nome}</h3>
                        <p class="text-gray-700 mt-1">${funcao}</p>
                        <p class="text-sm text-gray-500 mt-1">${telefone}</p>
                    </div>
                    <button data-member-id="${member.id}" class="details-button bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 flex-shrink-0">
                        Ver Detalhes
                    </button>
                `;
                memberList.appendChild(memberEl);
            });
        }
        
        /**
         * Atualiza o card do Dashboard com o total de membros.
         */
        function updateDashboard(total) {
            dashboardTotalMembros.textContent = total;
        }
        
        /**
         * Processa e renderiza as listas de aniversariantes.
         */
        function updateAniversariantes(membros) {
            const hoje = new Date();
            const mesAtual = hoje.getMonth(); // 0-11
            const anoAtual = hoje.getFullYear();
            
            aniverMesAtualTitulo.textContent = `Aniversariantes de ${MESES_DO_ANO[mesAtual]}`;
            
            const grupos = {};
            for (let i = 0; i < 12; i++) { grupos[i] = []; }

            // 1. Agrupar membros por mês
            membros.forEach(membro => {
                const dataNasc = getDateFromInput(membro.dataNascimento);
                if (dataNasc) {
                    const mes = dataNasc.getUTCMonth();
                    grupos[mes].push({
                        dia: dataNasc.getUTCDate(),
                        nome: membro.nome,
                        funcao: membro.funcao || 'Membro'
                    });
                }
            });

            // 2. Ordenar aniversariantes dentro de cada mês pelo dia
            for (let i = 0; i < 12; i++) {
                grupos[i].sort((a, b) => a.dia - b.dia);
            }

            // 3. Renderizar Mês Atual
            aniverMesAtualLista.innerHTML = "";
            if (grupos[mesAtual].length === 0) {
                aniverMesAtualLista.innerHTML = `<p class="text-gray-500">Nenhum aniversariante este mês.</p>`;
            } else {
                grupos[mesAtual].forEach(membro => {
                    const div = document.createElement('div');
                    div.className = "py-3 flex items-center space-x-4 border-b border-gray-200 last:border-b-0";
                    div.innerHTML = `
                        <div class="font-bold text-blue-600 text-2xl w-10 text-center">${membro.dia}</div>
                        <div class="flex-1">
                            <p class="text-base font-medium text-gray-900">${membro.nome}</p>
                            <p class="text-sm text-gray-500">${membro.funcao}</p>
                        </div>
                    `;
                    aniverMesAtualLista.appendChild(div);
                });
            }

            // 4. Renderizar Próximos Meses
            aniverProximosLista.innerHTML = "";
            let proximosMesesContent = "";
            for (let i = 1; i <= 11; i++) {
                const proximoMesIndex = (mesAtual + i) % 12;
                const mes = grupos[proximoMesIndex];
                
                if (mes.length > 0) {
                    let listaHTML = mes.map(membro => {
                        return `<li class="text-sm text-gray-700 ml-5 list-disc">${membro.dia} - ${membro.nome}</li>`;
                    }).join('');
                    
                    proximosMesesContent += `
                        <div class="py-2">
                            <h4 class="font-semibold text-lg text-blue-700">${MESES_DO_ANO[proximoMesIndex]}</h4>
                            <ul class="mt-2">${listaHTML}</ul>
                        </div>
                    `;
                }
            }
            aniverProximosLista.innerHTML = proximosMesesContent || `<p class="text-gray-500">Nenhum aniversariante nos próximos meses.</p>`;
        }

        // Função para filtrar e renderizar a lista
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const allMembers = Object.values(membersCache);
            
            const filteredMembers = allMembers.filter(member => {
                return (member.nome || '').toLowerCase().includes(searchTerm);
            });
            
            // Re-sorta os filtrados alfabeticamente
            filteredMembers.sort((a, b) => {
                const nameA = a.nome?.toLowerCase() || '';
                const nameB = b.nome?.toLowerCase() || '';
                if (nameA < nameB) return -1;
                if (nameA > nameB) return 1;
                return 0;
            });
            
            renderMemberList(filteredMembers);
        }

        /**
         * Inicia o listener em tempo real (onSnapshot) para a coleção de membros.
         */
        function listenForMembers() {
            if (!membersCollectionRef) return;
            if (unsubscribeMembers) unsubscribeMembers(); // Cancela listener anterior, se houver
            
            listLoading.classList.remove('hidden');
            const q = query(membersCollectionRef);

            unsubscribeMembers = onSnapshot(q, (snapshot) => {
                console.log("Recebido snapshot da coleção de membros.");
                membersCache = {}; // Limpa o cache
                let totalMembros = 0;
                
                const membrosParaAniversario = [];
                
                snapshot.docs.forEach(doc => {
                    const memberData = { id: doc.id, ...doc.data() };
                    membersCache[doc.id] = memberData;
                    membrosParaAniversario.push(memberData); // Adiciona para processamento
                    totalMembros++;
                });
                
                // Atualiza o dashboard e aniversariantes
                updateDashboard(totalMembros);
                updateAniversariantes(membrosParaAniversario);
                
                // Chama o handleSearch, que vai ler o cache
                // e aplicar o filtro (ou mostrar todos se o filtro estiver vazio)
                handleSearch();

            }, (error) => {
                console.error("Erro ao carregar membros: ", error);
                if (error.code === 'permission-denied' || error.code === 'unauthenticated') {
                     showMessage("Sessão expirada ou sem permissão. Faça login novamente.", "error");
                     signOut(auth); // Força o logout para mostrar a tela de login
                } else {
                    showMessage("Erro ao carregar lista de membros.", "error");
                }
                listLoading.classList.add('hidden');
                // Limpa dashboard e aniversariantes em caso de erro
                dashboardTotalMembros.textContent = "Erro";
                aniverMesAtualLista.innerHTML = `<p class="text-red-500">Erro ao carregar dados.</p>`;
                aniverProximosLista.innerHTML = `<p class="text-red-500">Erro ao carregar dados.</p>`;
            });
        }

        /**
         * [ALTERADO] Manipula o envio do formulário de cadastro, incluindo fotoUrl.
         */
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!userId) { 
                showMessage("Você precisa estar logado para cadastrar um membro.", "error");
                return;
            }

            submitButton.disabled = true;
            submitButtonText.textContent = 'Cadastrando...';
            const spinner = document.createElement('div');
            spinner.className = 'spinner h-5 w-5 border-2 border-white rounded-full';
            submitButton.prepend(spinner);

            try {
                const formData = new FormData(memberForm);
                
                // Mapeia os IDs do formulário (snake_case) para as chaves do banco de dados (camelCase)
                const newMember = {
                    createdAt: new Date(),
                    nome: formData.get('nome') || null,
                    funcao: formData.get('funcao') || null,
                    fotoUrl: formData.get('foto_url') || null, // [NOVO]
                    dataNascimento: formData.get('data_nascimento') || null,
                    telefone: formData.get('telefone') || null,
                    email: formData.get('email') || null,
                    cpf: formData.get('cpf') || null,
                    rg: formData.get('rg') || null,
                    naturalidade: formData.get('naturalidade') || null,
                    endereco: formData.get('endereco') || null,
                    nomePai: formData.get('nome_pai') || null,
                    nomeMae: formData.get('nome_mae') || null,
                    estadoCivil: formData.get('estado_civil') || null,
                    conjuge: (formData.get('estado_civil') === 'Casado(a)') ? formData.get('conjuge') : null,
                    profissao: formData.get('profissao') || null,
                    escolaridade: formData.get('escolaridade') || null,
                    dataBatismo: formData.get('data_batismo') || null,
                    dataChegada: formData.get('data_chegada') || null,
                    igrejaAnterior: formData.get('igreja_anterior') || null,
                    cargoAnterior: formData.get('cargo_anterior') || null
                };

                // Validação básica
                if (!newMember.nome || !newMember.email) {
                    showMessage("Nome e E-mail são campos obrigatórios.", "warning");
                    throw new Error("Validation failed");
                }

                const docRef = await addDoc(membersCollectionRef, newMember);
                console.log("Membro cadastrado com ID: ", docRef.id);
                
                // Registrar Log de Criação
                await registrarLog("Membro Criado", {
                    membroId: docRef.id,
                    nome: newMember.nome
                });
                
                showMessage("Membro cadastrado com sucesso!", "success");
                memberForm.reset();
                conjugeField.classList.add('hidden'); // Esconde campo cônjuge após reset
                fotoPreviewCadastro.classList.add('hidden'); // [NOVO] Esconde preview
                fotoPreviewCadastro.src = '';

            } catch (error) {
                console.error("Erro ao adicionar membro: ", error);
                if (error.message !== "Validation failed") {
                    showMessage("Erro ao cadastrar membro. Tente novamente.", "error");
                }
            } finally {
                submitButton.disabled = false;
                submitButtonText.textContent = 'Cadastrar Membro';
                if(submitButton.firstChild) {
                    submitButton.removeChild(submitButton.firstChild);
                }
            }
        }
        
        /**
         * [ALTERADO] Manipula o envio do formulário de EDIÇÃO, incluindo fotoUrl.
         */
        async function handleEditSubmit(e) {
            e.preventDefault();
            if (!userId || !currentMemberId) return;

            const password = document.getElementById('edit-password').value;
            if (!password) {
                editError.textContent = 'A senha é obrigatória para salvar.';
                return;
            }

            // Ativa o loading
            editSubmitButton.disabled = true;
            editSubmitButtonText.textContent = 'Salvando...';
            const spinner = document.createElement('div');
            spinner.className = 'spinner h-5 w-5 border-2 border-white rounded-full';
            editSubmitButton.prepend(spinner);
            editError.textContent = '';

            try {
                // 1. Reautenticar
                await reauthenticateUser(password);

                // Captura os dados antigos ANTES de coletar os novos
                const membroOriginal = membersCache[currentMemberId];

                // 2. Coletar dados do formulário
                const formData = new FormData(editForm);
                const updatedMember = {
                    nome: formData.get('nome') || null,
                    funcao: formData.get('funcao') || null,
                    fotoUrl: formData.get('foto_url') || null, // [NOVO]
                    dataNascimento: formData.get('data_nascimento') || null,
                    telefone: formData.get('telefone') || null,
                    email: formData.get('email') || null,
                    cpf: formData.get('cpf') || null,
                    rg: formData.get('rg') || null,
                    naturalidade: formData.get('naturalidade') || null,
                    endereco: formData.get('endereco') || null,
                    nomePai: formData.get('nome_pai') || null,
                    nomeMae: formData.get('nome_mae') || null,
                    estadoCivil: formData.get('estado_civil') || null,
                    conjuge: (formData.get('estado_civil') === 'Casado(a)') ? formData.get('conjuge') : null,
                    profissao: formData.get('profissao') || null,
                    escolaridade: formData.get('escolaridade') || null,
                    dataBatismo: formData.get('data_batismo') || null,
                    dataChegada: formData.get('data_chegada') || null,
                    igrejaAnterior: formData.get('igreja_anterior') || null,
                    cargoAnterior: formData.get('cargo_anterior') || null,
                    updatedAt: new Date() // Adiciona um timestamp de atualização
                };

                // 3. Atualizar no Firestore
                const docRef = doc(db, "dadosIgreja", "ADCA-CG", "membros", currentMemberId);
                await updateDoc(docRef, updatedMember);
                
                // Registrar Log de Atualização
                await registrarLog("Membro Atualizado", {
                    membroId: currentMemberId,
                    nome: updatedMember.nome,
                    dadosAntigos: membroOriginal,
                    dadosNovos: updatedMember
                });

                // 4. Sucesso
                showMessage("Membro atualizado com sucesso!", "success");
                hideModal(editModal);
                currentMemberId = null; // Limpa o ID selecionado

            } catch (error) {
                console.error("Erro ao atualizar membro:", error);
                editError.textContent = error.message; // Exibe "Senha incorreta." ou outro erro
            } finally {
                // Desativa o loading
                editSubmitButton.disabled = false;
                editSubmitButtonText.textContent = 'Salvar Alterações';
                if(editSubmitButton.firstChild) {
                    editSubmitButton.removeChild(editSubmitButton.firstChild);
                }
            }
        }
        
        /**
         * Manipula o envio do formulário de EXCLUSÃO.
         */
        async function handleDeleteSubmit(e) {
            e.preventDefault();
            if (!userId || !currentMemberId) return;

            const password = document.getElementById('delete-password').value;
            if (!password) {
                deleteError.textContent = 'A senha é obrigatória para excluir.';
                return;
            }
            
            // Ativa o loading
            deleteSubmitButton.disabled = true;
            deleteSubmitButtonText.textContent = 'Excluindo...';
            const spinner = document.createElement('div');
            spinner.className = 'spinner h-5 w-5 border-2 border-white rounded-full';
            deleteSubmitButton.prepend(spinner);
            deleteError.textContent = '';

            try {
                // 1. Reautenticar
                await reauthenticateUser(password);

                // Captura os dados que serão excluídos
                const membroExcluido = membersCache[currentMemberId];

                // 2. Excluir do Firestore
                const docRef = doc(db, "dadosIgreja", "ADCA-CG", "membros", currentMemberId);
                await deleteDoc(docRef);

                // Registrar Log de Exclusão
                await registrarLog("Exclusão Membro", {
                    membroId: currentMemberId,
                    detalhesExcluidos: membroExcluido
                });

                // 3. Sucesso
                showMessage("Membro excluído com sucesso!", "success");
                hideModal(deleteModal);
                currentMemberId = null; // Limpa o ID selecionado

            } catch (error) {
                console.error("Erro ao excluir membro:", error);
                deleteError.textContent = error.message; // Exibe "Senha incorreta." ou outro erro
            } finally {
                // Desativa o loading
                deleteSubmitButton.disabled = false;
                deleteSubmitButtonText.textContent = 'Excluir Permanentemente';
                if(deleteSubmitButton.firstChild) {
                    deleteSubmitButton.removeChild(deleteSubmitButton.firstChild);
                }
            }
        }

        /**
         * [ALTERADO] Alterna a visibilidade das abas e inicializa o Postimages se necessário.
         */
        function switchTab(targetId) {
            // Esconde todos os conteúdos
            document.querySelectorAll('.app-content-tab').forEach(tab => {
                tab.style.display = 'none'; // Usa display: none conforme seu CSS
            });
            // Remove 'active' de todos os botões
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            // Mostra o conteúdo alvo
            const content = document.getElementById(targetId);
            if (content) {
                content.style.display = 'block'; // Usa display: block conforme seu CSS
            }
            // Adiciona 'active' ao botão alvo
            const activeButton = document.querySelector(`.app-tab-button[data-tab="${targetId}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // [NOVO] Força a reinicialização do Postimages
            // Se a aba for a de cadastro E o script PostImage já tiver sido carregado
            if (targetId === 'cadastro' && typeof PostImage !== 'undefined') {
                PostImage.init();
            }
        }

        /**
         * Função principal de inicialização.
         */
        async function main() {
            try {
                // Inicializa Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('Debug'); // Descomente para mais logs
                console.log("Firebase App inicializado. Projeto:", firebaseConfig.projectId);

                // Gerencia a autenticação
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Usuário ESTÁ logado
                        userId = user.uid;
                        userEmailDisplay.textContent = user.email;
                        userEmailDisplay.classList.remove('hidden');
                        console.log("Usuário autenticado:", userId);

                        // Remove o 'flex' do body para alinhar o app no topo
                        document.body.classList.remove('logged-out');

                        // Esconde login, mostra app
                        authScreen.style.display = 'none';
                        appContent.style.display = 'block';

                        // Define a referência da coleção (SÓ DEPOIS de logar)
                        membersCollectionRef = collection(db, "dadosIgreja", "ADCA-CG", "membros");
                        console.log("Caminho da coleção:", membersCollectionRef.path);
                        
                        // Define a aba inicial
                        switchTab('dashboard');

                        // Começa a ouvir os dados
                        listenForMembers();
                    
                    } else {
                        // Usuário NÃO está logado
                        console.log("Nenhum usuário. Exibindo tela de login.");
                        userId = null;
                        userEmailDisplay.classList.add('hidden');
                        
                        // Adiciona 'flex' ao body para centralizar o login
                        document.body.classList.add('logged-out');
                        
                        // Esconde app, mostra login
                        authScreen.style.display = 'block';
                        appContent.style.display = 'none';

                        // Para de ouvir dados se estava ouvindo
                        if (unsubscribeMembers) {
                            unsubscribeMembers();
                            unsubscribeMembers = null;
                            console.log("Listener de membros interrompido.");
                        }
                        // Limpa dados da tela
                        memberList.innerHTML = '';
                        membersCache = {};
                        dashboardTotalMembros.innerHTML = `<div class="spinner h-10 w-10 border-4 border-blue-500 rounded-full"></div>`;
                        aniverMesAtualLista.innerHTML = `<div class="spinner h-8 w-8 border-4 border-blue-500 rounded-full"></div>`;
                        aniverProximosLista.innerHTML = `<div class="spinner h-8 w-8 border-4 border-blue-500 rounded-full"></div>`;
                        
                        // Fecha todos os modais caso estejam abertos
                        hideModal(detailsModal);
                        hideModal(editModal);
                        hideModal(deleteModal);
                    }
                });

                // --- Event Listeners ---

                // Listener do Formulário de Login
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    loginError.textContent = ''; // Limpa erro anterior
                    
                    const email = document.getElementById('login-email').value;
                    const password = document.getElementById('login-password').value;

                    // Mostra estado de carregamento
                    loginButton.disabled = true;
                    loginButtonText.textContent = 'Entrando...';
                    const spinner = document.createElement('div');
                    spinner.className = 'spinner'; // Usa a classe .spinner do seu CSS
                    loginButton.prepend(spinner);

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        // Sucesso! onAuthStateChanged vai cuidar de mostrar o app
                    } catch (error) {
                        console.error("Erro no login:", error.code);
                        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                            loginError.textContent = 'Email ou senha inválidos.';
                        } else {
                            loginError.textContent = 'Erro ao tentar fazer login.';
                        }
                    } finally {
                        // Remove estado de carregamento
                        loginButton.disabled = false;
                        loginButtonText.textContent = 'Entrar';
                        if (loginButton.firstChild && loginButton.firstChild.classList.contains('spinner')) {
                            loginButton.removeChild(loginButton.firstChild);
                        }
                    }
                });

                // Listener do Botão de Logout
                logoutButton.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        // Sucesso! onAuthStateChanged vai cuidar de mostrar o login
                    } catch (error) {
                        console.error("Erro ao sair:", error);
                        showMessage("Erro ao tentar sair.", "error");
                    }
                });
                
                // Abas
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        // 'tab-btn-cadastro' -> 'cadastro'
                        const tabId = button.dataset.tab;
                        switchTab(tabId);
                    });
                });

                // Formulário de Cadastro
                memberForm.addEventListener('submit', handleFormSubmit);
                estadoCivilSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'Casado(a)') {
                        conjugeField.classList.remove('hidden');
                    } else {
                        conjugeField.classList.add('hidden');
                    }
                });

                // Formulário de Edição
                editForm.addEventListener('submit', handleEditSubmit);
                editEstadoCivilSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'Casado(a)') {
                        editConjugeField.classList.remove('hidden');
                    } else {
                        editConjugeField.classList.add('hidden');
                    }
                });
                
                // Formulário de Exclusão
                deleteForm.addEventListener('submit', handleDeleteSubmit);
                
                // [NOVO] Listener da Barra de Pesquisa
                searchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleSearch();
                });

                clearSearchButton.addEventListener('click', () => {
                    searchInput.value = '';
                    handleSearch(); // Chama a pesquisa com campo vazio (mostra todos)
                });

                // Lista de Membros (Delegação de Eventos para Modal)
                memberList.addEventListener('click', (e) => {
                    const detailsButton = e.target.closest('.details-button');
                    if (detailsButton) {
                        currentMemberId = detailsButton.dataset.memberId; // Salva o ID
                        const memberData = membersCache[currentMemberId];
                        if (memberData) {
                            showDetailsModal();
                        } else {
                            console.warn("Não foi possível encontrar dados do membro no cache para o ID:", currentMemberId);
                            showMessage("Erro ao carregar detalhes.", "error");
                        }
                    }
                });
                
                // Botões do Modal de Detalhes
                modalEditBtn.addEventListener('click', () => {
                    const member = membersCache[currentMemberId];
                    if (member) {
                        populateEditForm(member);
                        hideModal(detailsModal);
                        showModal('edit-modal');
                        
                        // [NOVO] Força a reinicialização do Postimages
                        if (typeof PostImage !== 'undefined') {
                            PostImage.init();
                        }
                    }
                });
                
                modalDeleteBtn.addEventListener('click', () => {
                    deleteError.textContent = ''; // Limpa erro anterior
                    document.getElementById('delete-password').value = ''; // Limpa senha
                    hideModal(detailsModal);
                    showModal('delete-modal');
                });

                // Listeners para fechar Modais
                allCloseModalButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const modal = e.target.closest('.modal');
                        hideModal(modal);
                    });
                });
                
                // Fecha modal ao clicar no backdrop (fundo)
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        // Se o clique foi no próprio modal (backdrop) e não no content
                        if (e.target === modal) {
                            hideModal(modal);
                        }
                    });
                });


            } catch (e) {
                console.error("Erro crítico na inicialização do Firebase:", e);
                document.body.innerHTML = `<div class="p-8 text-red-600">Erro crítico ao conectar. Verifique o console.</div>`;
            }
        }

        // Inicia a aplicação quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', main);

    </script>
</body>
</html>
